<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>菜刚RyuGou的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="菜刚RyuGou的博客">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="菜刚RyuGou的博客">
<meta property="og:locale">
<meta property="article:author" content="菜刚">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="菜刚RyuGou的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">菜刚RyuGou的博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-http-cache" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/29/http-cache/" class="article-date">
  <time datetime="2018-04-28T18:09:58.000Z" itemprop="datePublished">2018-04-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/29/http-cache/">HTTP 缓存详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h3><p>HTTP缓存主要用在对一些实时性要求不高的静态文件进行的缓存，往往都是存在浏览器端，防止这些“多余”的请求重复的访问服务器，对服务器造成压力，从而提高网站的性能。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>现有两端，浏览器C和服务器端S。</p>
<p><img src="/img/http_cache/http_cache_1.jpeg" alt="这里写图片描述"></p>
<p>浏览器向服务器发送请求，获取一个文件f</p>
<p><img src="/img/http_cache/http_cache_2.jpeg" alt="这里写图片描述"></p>
<p>服务器就把f给返回浏览器</p>
<p><img src="/img/http_cache/http_cache_3.jpeg" alt="这里写图片描述"></p>
<p>假如这个文件的内容变化不是那么快，一两周更新一次，浏览器每次请求服务器都返回相同的文件，岂不是对服务器资源的一种浪费？</p>
<p>如何解决呢？</p>
<p>浏览器把请求后拿到的文件存到本地，等下次请求的时候，看看本地是否有缓存文件，如果有，直接拿本地的文件，岂不是就不用请求服务器了？这其实就是http缓存的最最根本的原理。</p>
<p>C端浏览器端把请求来的文件缓存到如图下f的小方格内<br><img src="/img/http_cache/http_cache_4.jpeg" alt="这里写图片描述"></p>
<p>等到下次C端再次请求此文件时，就直接从浏览器缓存的文件中拿，而不再向S服务器端发起请求了</p>
<p><img src="/img/http_cache/http_cache_5.jpeg" alt="这里写图片描述"></p>
<p>以下浏览器截图中标红的部分，就是没有发起请求，直接从浏览器缓存中获取的数据</p>
<p><img src="/img/http_cache/http_cache_6.jpeg" alt="这里写图片描述"></p>
<h3 id="两种缓存方式"><a href="#两种缓存方式" class="headerlink" title="两种缓存方式"></a>两种缓存方式</h3><p>浏览器端有了缓存之后，不能一直有效吧，如果文件更新了，我们还继续使用浏览器缓存中的数据，虽说时效性不强，但长期使用旧文件也不算合理吧。</p>
<p>http协议提供了两种维度来让缓存失效：时间和文件的修改。</p>
<h3 id="利用时间来让缓存失效"><a href="#利用时间来让缓存失效" class="headerlink" title="利用时间来让缓存失效"></a>利用时间来让缓存失效</h3><p>时间维度很简单，就是设定一个缓存时间段，过了这个时间段，缓存就自动失效了，浏览器就会发起请求获取文件。这个设定时间的http字段就是<code>cache-control</code>字段。</p>
<p><code>cache-control</code> 可设置的字段值有：</p>
<ul>
<li>private ：客户端可以缓存</li>
<li>public ：客户端和代理服务器都可缓存，大部分情况可以认为public和private是一样的</li>
<li>max-age&#x3D;xxx ：   缓存的内容将在 xxx 秒后失效 (时间就是在这儿设置的)</li>
<li>no-cache ：需要使用另外一种http缓存策略来验证缓存数据</li>
<li>no-store ：所有缓存策略都不会进行(这里指的是两种缓存策略都不会进行)</li>
</ul>
<p>cache-control 缓存原理</p>
<p>第一次访问请求，客户端C向服务端S发起一个文件请求，服务器返回文件并在<code>response</code>中加了响应头”Cache-Control:max-age&#x3D;60”，这样一来，这个f文件只能在浏览器端存<br>60秒</p>
<p><img src="/img/http_cache/http_cache_7.jpeg" alt="这里写图片描述"></p>
<p>在这60秒钟，客户端请求服务器的f文件会直接从缓存中拿取</p>
<p><img src="/img/http_cache/http_cache_8.jpeg" alt="这里写图片描述"></p>
<p>60秒过后，缓存失效，浏览器再次请求文件需要重新向服务器发起请求。</p>
<p><img src="/img/http_cache/http_cache_9.jpeg" alt="这里写图片描述"></p>
<p>注意：假如说请求中包含“Cache-Control:max-age&#x3D;0”或者“Cache-Control:no-store”无论响应中返回的”max-age”值是多少，都不会缓存到服务器。浏览器中对于地址栏中直接输入文件地址的请求做了优化处理，加上了“Cache-Control:max-age&#x3D;0”，也就是说，如果这个css、js或者其他静态文件是通过你在浏览器上直接输入获得的，将会每时每刻都是获取最新的。</p>
<h3 id="通过查看文件的修改来让缓存失效"><a href="#通过查看文件的修改来让缓存失效" class="headerlink" title="通过查看文件的修改来让缓存失效"></a>通过查看文件的修改来让缓存失效</h3><p>这种维度比较的科学：浏览器先请求服务获得文件后，服务器会返回该文件的最后修改时间<code>Last-Modified</code>，作为文件的一个标识，下次浏览器请求的时候，会带着这个标识去请求(此时为<code>If-Modified-Since</code>)，然后服务器做校验，如果说时间标识<code>If-Modified-Since</code>等于服务器的文件修改时间，则说明没有修改，返回304状态码，浏览器从缓存中获取文件，但是如果浏览器保存的时间标识<code>If-Modified-Since</code>小于服务器端的文件修改时间，那么，说明文件发生了修改，浏览器就会重新获取新的文件。<br>（<code>If-Modified-Since</code>的时间如果大于服务器端文件的时间，会被认为是错误的请求）</p>
<p>如图，浏览器C向服务器发S起请求，服务器S返回文件的同时还会返回文件的最后修改时间<code>Last-Modified</code>作为文件时间标识，浏览器会将文件和文件时间标识都缓存起来。</p>
<p><img src="/img/http_cache/http_cache_10.jpeg" alt="这里写图片描述"></p>
<p>假如服务器端的文件f并没有被修改，服务器通过判断请求头带的时间标识<code>If-Modified-Since</code>得出结论后，都会返回状态码<code>304</code>告诉浏览器文件没有被修改，让浏览器使用缓存。</p>
<p><img src="/img/http_cache/http_cache_11.jpeg" alt="这里写图片描述"></p>
<p>假如服务器端的文件f修改了，那么，浏览器将重新获取文件，并缓存到浏览器中。</p>
<p><img src="/img/http_cache/http_cache_12.jpeg" alt="这里写图片描述"></p>
<p>虽然通过文件最后修改时间作为标识已经很完美了，但是，还是可能存在一个问题：就是有可能服务器端的文件修改后，又改回原来的样子，这样，虽然文件最后修改时间变了，但是，文件内容并没有改变。这样还是会有多余的请求到达服务器，该如何处理呢？<br>可以将文件内容作为一个唯一标识，例如可以对文件内容取MD5值作为字段(<code>etag</code>)也传给浏览器端，假如这个文件内容没变化，那么MD5值也不会改变。那么，处理流程就变成了这样：服务器端先判断文件修改时间是否发生了变化，如果发生了变化，那么再对比浏览器传来的<code>If-None-Match</code>即浏览器端保留的<code>E-tag</code>值，如果发生了变化，则证明文件修改了，需要浏览器重新下载文件，如果没有，则证明文件内容没变化，返回304状态码。</p>
<p>如图，浏览器C要访问服务器S的f文件，服务器S返回了文件最后修改时间<code>Last-Modified</code>和文件的内容标识<code>E-tag</code>，浏览器将这两个字段及其文件缓存了起来</p>
<p><img src="/img/http_cache/http_cache_13.jpeg" alt="这里写图片描述"></p>
<p>当文件最后修改时间没变，文件内容也没变的时候，返回304，让浏览器从缓存中拿取文件。</p>
<p><img src="/img/http_cache/http_cache_14.jpeg" alt="这里写图片描述"></p>
<p>当文件最后修改时间变了，文件内容没变的时候，返回304，让浏览器从缓存中拿取文件。</p>
<p><img src="/img/http_cache/http_cache_15.jpeg" alt="这里写图片描述"></p>
<p>当文件修改时间变了，文件内容也变了的时候，服务器会重新下发新的文件给浏览器。</p>
<p><img src="/img/http_cache/http_cache_16.jpeg" alt="这里写图片描述"></p>
<p>此维度让缓存失效牵扯的http字段有点多，我们最后整理一下：<br>文件最后修改时间字段：</p>
<ul>
<li>Response：<code>Last-Modified</code></li>
<li>Request：<code>If-Modified-Since</code></li>
</ul>
<p>文件内容标识字段：</p>
<ul>
<li>Response：<code>E-tag</code></li>
<li>Request：<code>If-None-Match</code></li>
</ul>
<h3 id="请关注我"><a href="#请关注我" class="headerlink" title="请关注我"></a>请关注我</h3><p>更多精彩内容，请搜索我的微信公众号 <code>码农RyuGou</code></p>
<p>或者扫码<img src="/img/weichat/qrcode.jpg"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/04/29/http-cache/" data-id="clzo46btj001dvajh6loh4lv8" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-WeiboSummary" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/05/WeiboSummary/" class="article-date">
  <time datetime="2018-04-05T08:05:52.000Z" itemprop="datePublished">2018-04-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/05/WeiboSummary/">微博git使用中那些可圈可点的地方</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="构造干净的git历史线索"><a href="#构造干净的git历史线索" class="headerlink" title="构造干净的git历史线索"></a>构造干净的git历史线索</h3><h4 id="一般公司git的使用方式："><a href="#一般公司git的使用方式：" class="headerlink" title="一般公司git的使用方式："></a>一般公司git的使用方式：</h4><ul>
<li>一个master分支、一个dev分支，多个feature分支。</li>
<li>一个功能点或者功能模块一个feature分支，除了日常的正常的在feature分支的提交，还要注意从master中pull最新的代码到当前所在的feature分支上，以保证当前代码是在最新的代码基础之上开发的，当前feature分支开发结束后，合并到dev分支，等到下一版本的所有feature分支都提交到dev(有时候不用所有的，dev有几个feature分支测几个功能点),测试同学在dev分支上展开测试，测试过程中产生的bug，再拎出一个或者多个feature分支进行修改，直到没问题，然后将dev中的代码合并到master，上线，然后线上回归，接着改bug。</li>
</ul>
<p>合并分支所涉及的git指令有:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git pull origin master //在feature分支上</span><br><span class="line">git checkout dev </span><br><span class="line">git pull</span><br><span class="line">git merge feature</span><br><span class="line">git push</span><br><span class="line"></span><br><span class="line">//最后上线</span><br><span class="line">git checkout master</span><br><span class="line">git pull</span><br><span class="line">git merge dev</span><br><span class="line">git push</span><br></pre></td></tr></table></figure>
<p>然后生成的git历史线<br><img src="/img/weibo/chuantaiyi.png" alt="img">  </p>
<p>呃。。。乱！</p>
<h4 id="微博工作中的使用："><a href="#微博工作中的使用：" class="headerlink" title="微博工作中的使用："></a>微博工作中的使用：</h4><ul>
<li>一个master分支，一个或者多个feature分支。</li>
<li>无dev分支，通常情况下远程分支只有一master分支，一两个feature分支（两个都是多的），从主干master中分出feature，开发过程中随时更新master上最新的代码，不用pull命令，而是rebase，测试环境直接用feature分支，测出的问题直接向feature分支中提，测的没问题之后，最后合并到master。</li>
<li>在把feature分支合并到master的时候，将多个commit合并成一个。</li>
<li>每个commit的内容都要写清楚</li>
</ul>
<p>合并分支所涉及的git指令:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git checkout master </span><br><span class="line">git pull</span><br><span class="line">git checkout feature</span><br><span class="line">git rebase master</span><br><span class="line">git push —force </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将多个commit合并成一个的方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git reset --soft xxxxxxxxxx</span><br><span class="line">git add xxxx</span><br><span class="line">git commit -m &quot;xxxx&quot;</span><br><span class="line">git push -f //一定要强制推送</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><img src="/img/weibo/weibo_rebase.png" alt="img"></p>
<p>特别清晰有木有！</p>
<h4 id="git-merge和-git-rebase的区别"><a href="#git-merge和-git-rebase的区别" class="headerlink" title="git merge和 git rebase的区别"></a><code>git merge</code>和 <code>git rebase</code>的区别</h4><p>一句话概括：<code>git rebase</code>不产生“分叉”，就像在同一个分支上<code>commit</code>了一样，而merge会产生“分叉”</p>
<p>如下图：</p>
<p><img src="/img/weibo/merge_rebase.jpg" alt="img"></p>
<p><code>git pull</code> 等于<code>git fetch</code>加 <code>git merge</code>，每次从master更新代码的时候，如果使用<code>git pull origin master</code>相当于每次更新就<code>merge</code>了一下，因而会有很多“乱线” </p>
<h3 id="git-工具选择"><a href="#git-工具选择" class="headerlink" title="git 工具选择"></a>git 工具选择</h3><p>不要<code>SourceTree</code>、不要<code>Smartgit</code>，只用phpstrom自带的。</p>
<h4 id="查看异同并修改很方便"><a href="#查看异同并修改很方便" class="headerlink" title="查看异同并修改很方便"></a>查看异同并修改很方便</h4><p>准备提交代码:<br><img src="/img/weibo/shangchuan.png" alt="img"></p>
<p>查看修改了什么：<br><img src="/img/weibo/chakan.png" alt="img"></p>
<p>可以选择“查看不同”、“回滚整个文件”、“编辑当前代码”等操作,现在选择查看不同<br><img src="/img/weibo/chakan_diff.png" alt="img"></p>
<p>点击”x”可以直接回滚到原来</p>
<p><img src="/img/weibo/chakan1.png" alt="img"></p>
<p>填写commit、提交等操作</p>
<p><img src="/img/weibo/chakan1.png" alt="img"></p>
<p>不用来回切换工具，直接用IDE本身，会带来很多方便，IDE的可视化效果也比较好，可以清楚的看到改动的地方，并直接在IDE中修改，能够减少“忘记改动”带来的bug</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/04/05/WeiboSummary/" data-id="clzo46bt8000evajhgw0m2i6b" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/git/" rel="tag">git</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-golang-concurrency-principle" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/04/golang-concurrency-principle/" class="article-date">
  <time datetime="2017-12-04T04:42:20.000Z" itemprop="datePublished">2017-12-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/04/golang-concurrency-principle/">Go并发原理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Go语言是为并发而生的语言，Go语言是为数不多的在语言层面实现并发的语言；也正是Go语言的并发特性，吸引了全球无数的开发者。</p>
<h1 id="并发-concurrency-和并行-parallellism"><a href="#并发-concurrency-和并行-parallellism" class="headerlink" title="并发(concurrency)和并行(parallellism)"></a>并发(concurrency)和并行(parallellism)</h1><p>**并发(concurrency)**：两个或两个以上的任务在一段时间内被执行。我们不必care这些任务在某一个时间点是否是同时执行，可能同时执行，也可能不是，我们只关心在一段时间内，哪怕是很短的时间（一秒或者两秒）是否执行解决了两个或两个以上任务。</p>
<p><strong>并行(parallellism)：</strong>两个或两个以上的任务在同一时刻被同时执行。</p>
<p>并发说的是逻辑上的概念，而并行，强调的是物理运行状态。并发“包含”并行。</p>
<p>（详情请见：Rob Pike 的<a href="https://talks.golang.org/2012/concurrency.slide#1">PPT</a>）</p>
<h1 id="Go的CSP并发模型"><a href="#Go的CSP并发模型" class="headerlink" title="Go的CSP并发模型"></a>Go的CSP并发模型</h1><p>Go实现了两种并发形式。第一种是大家普遍认知的：多线程共享内存。其实就是Java或者C++等语言中的多线程开发。另外一种是Go语言特有的，也是Go语言推荐的：CSP（communicating sequential processes）并发模型。</p>
<p>CSP并发模型是在1970年左右提出的概念，属于比较新的概念，不同于传统的多线程通过共享内存来通信，CSP讲究的是“以通信的方式来共享内存”。</p>
<p>请记住下面这句话：<br><strong>Do not communicate by sharing memory; instead, share memory by communicating.</strong><br>“不要以共享内存的方式来通信，相反，要通过通信来共享内存。”</p>
<p>普通的线程并发模型，就是像Java、C++、或者Python，他们线程间通信都是通过共享内存的方式来进行的。非常典型的方式就是，在访问共享数据（例如数组、Map、或者某个结构体或对象）的时候，通过锁来访问，因此，在很多时候，衍生出一种方便操作的数据结构，叫做“线程安全的数据结构”。例如Java提供的包”java.util.concurrent”中的数据结构。Go中也实现了传统的线程并发模型。</p>
<p>Go的CSP并发模型，是通过<code>goroutine</code>和<code>channel</code>来实现的。</p>
<ul>
<li><code>goroutine</code> 是Go语言中并发的执行单位。有点抽象，其实就是和传统概念上的”线程“类似，可以理解为”线程“。</li>
<li><code>channel</code>是Go语言中各个并发结构体(<code>goroutine</code>)之前的通信机制。 通俗的讲，就是各个<code>goroutine</code>之间通信的”管道“，有点类似于Linux中的管道。</li>
</ul>
<p>生成一个<code>goroutine</code>的方式非常的简单：Go一下，就生成了。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> f();</span><br></pre></td></tr></table></figure>


<p>通信机制<code>channel</code>也很方便，传数据用<code>channel &lt;- data</code>，取数据用<code>&lt;-channel</code>。</p>
<p>在通信过程中，传数据<code>channel &lt;- data</code>和取数据<code>&lt;-channel</code>必然会成对出现，因为这边传，那边取，两个<code>goroutine</code>之间才会实现通信。</p>
<p>而且不管传还是取，必阻塞，直到另外的<code>goroutine</code>传或者取为止。</p>
<p>有两个<code>goroutine</code>，其中一个发起了向<code>channel</code>中发起了传值操作。（<code>goroutine</code>为矩形，<code>channel</code>为箭头）</p>
<p><img src="/img/csp/send.png"></p>
<p>左边的<code>goroutine</code>开始阻塞，等待有人接收。</p>
<p>这时候，右边的<code>goroutine</code>发起了接收操作。</p>
<p><img src="/img/csp/accept.png"></p>
<p>右边的<code>goroutine</code>也开始阻塞，等待别人传送。</p>
<p>这时候，两边<code>goroutine</code>都发现了对方，于是两个<code>goroutine</code>开始一传，一收。</p>
<p><img src="/img/csp/communicate.png"></p>
<p>这便是Golang CSP并发模型最基本的形式。</p>
<h1 id="Go并发模型的实现原理"><a href="#Go并发模型的实现原理" class="headerlink" title="Go并发模型的实现原理"></a>Go并发模型的实现原理</h1><p>我们先从线程讲起，无论语言层面何种并发模型，到了操作系统层面，一定是以线程的形态存在的。而操作系统根据资源访问权限的不同，体系架构可分为用户空间和内核空间；内核空间主要操作访问CPU资源、I&#x2F;O资源、内存资源等硬件资源，为上层应用程序提供最基本的基础资源，用户空间呢就是上层应用程序的固定活动空间，用户空间不可以直接访问资源，必须通过“系统调用”、“库函数”或“Shell脚本”来调用内核空间提供的资源。</p>
<p>我们现在的计算机语言，可以狭义的认为是一种“软件”，它们中所谓的“线程”，往往是用户态的线程，和操作系统本身内核态的线程（简称KSE），还是有区别的。</p>
<p>线程模型的实现，可以分为以下几种方式：</p>
<h3 id="用户级线程模型"><a href="#用户级线程模型" class="headerlink" title="用户级线程模型"></a>用户级线程模型</h3><p><img src="/img/csp/yonghutai.png"></p>
<p>如图所示，多个用户态的线程对应着一个内核线程，程序线程的创建、终止、切换或者同步等线程工作必须自身来完成。</p>
<h3 id="内核级线程模型"><a href="#内核级线程模型" class="headerlink" title="内核级线程模型"></a>内核级线程模型</h3><p><img src="/img/csp/neiheji.png"></p>
<p>这种模型直接调用操作系统的内核线程，所有线程的创建、终止、切换、同步等操作，都由内核来完成。C++就是这种。</p>
<h3 id="两级线程模型"><a href="#两级线程模型" class="headerlink" title="两级线程模型"></a>两级线程模型</h3><p><img src="/img/csp/liangji.png"></p>
<p>这种模型是介于用户级线程模型和内核级线程模型之间的一种线程模型。这种模型的实现非常复杂，和内核级线程模型类似，一个进程中可以对应多个内核级线程，但是进程中的线程不和内核线程一一对应；这种线程模型会先创建多个内核级线程，然后用自身的用户级线程去对应创建的多个内核级线程，自身的用户级线程需要本身程序去调度，内核级的线程交给操作系统内核去调度。</p>
<p>Go语言的线程模型就是一种特殊的两级线程模型。暂且叫它“MPG”模型吧。</p>
<h2 id="Go线程实现模型MPG"><a href="#Go线程实现模型MPG" class="headerlink" title="Go线程实现模型MPG"></a>Go线程实现模型MPG</h2><p><code>M</code>指的是<code>Machine</code>，一个<code>M</code>直接关联了一个内核线程。<br><code>P</code>指的是”processor”，代表了<code>M</code>所需的上下文环境，也是处理用户级代码逻辑的处理器。<br><code>G</code>指的是<code>Goroutine</code>，其实本质上也是一种轻量级的线程。</p>
<p>三者关系如下图所示：</p>
<p><img src="/img/csp/GMPrelation.png"></p>
<p>以上这个图讲的是两个线程(内核线程)的情况。一个M会对应一个内核线程，一个M也会连接一个上下文P，一个上下文P相当于一个“处理器”，一个上下文连接一个或者多个Goroutine。P(Processor)的数量是在启动时被设置为环境变量GOMAXPROCS的值，或者通过运行时调用函数<code>runtime.GOMAXPROCS()</code>进行设置。Processor数量固定意味着任意时刻只有固定数量的线程在运行go代码。Goroutine中就是我们要执行并发的代码。图中P正在执行的<code>Goroutine</code>为蓝色的；处于待执行状态的<code>Goroutine</code>为灰色的，灰色的<code>Goroutine</code>形成了一个队列<code>runqueues</code></p>
<p>三者关系的宏观的图为：</p>
<p><img src="/img/csp/total.png"></p>
<h4 id="抛弃P-Processor"><a href="#抛弃P-Processor" class="headerlink" title="抛弃P(Processor)"></a>抛弃P(Processor)</h4><p>你可能会想，为什么一定需要一个上下文，我们能不能直接除去上下文，让<code>Goroutine</code>的<code>runqueues</code>挂到M上呢？答案是不行，需要上下文的目的，是让我们可以直接放开其他线程，当遇到内核线程阻塞的时候。</p>
<p>一个很简单的例子就是系统调用<code>sysall</code>，一个线程肯定不能同时执行代码和系统调用被阻塞，这个时候，此线程M需要放弃当前的上下文环境P，以便可以让其他的<code>Goroutine</code>被调度执行。</p>
<p><img src="/img/csp/giveupP.png"></p>
<p>如上图左图所示，M0中的G0执行了syscall，然后就创建了一个M1(也有可能本身就存在，没创建)，（转向右图）然后M0丢弃了P，等待syscall的返回值，M1接受了P，将·继续执行<code>Goroutine</code>队列中的其他<code>Goroutine</code>。</p>
<p>当系统调用syscall结束后，M0会“偷”一个上下文，如果不成功，M0就把它的Gouroutine G0放到一个全局的runqueue中，然后自己放到线程池或者转入休眠状态。全局runqueue是各个P在运行完自己的本地的Goroutine runqueue后用来拉取新goroutine的地方。P也会周期性的检查这个全局runqueue上的goroutine，否则，全局runqueue上的goroutines可能得不到执行而饿死。</p>
<h4 id="均衡的分配工作"><a href="#均衡的分配工作" class="headerlink" title="均衡的分配工作"></a>均衡的分配工作</h4><p>按照以上的说法，上下文P会定期的检查全局的goroutine 队列中的goroutine，以便自己在消费掉自身Goroutine队列的时候有事可做。假如全局goroutine队列中的goroutine也没了呢？就从其他运行的中的P的runqueue里偷。</p>
<p>每个P中的<code>Goroutine</code>不同导致他们运行的效率和时间也不同，在一个有很多P和M的环境中，不能让一个P跑完自身的<code>Goroutine</code>就没事可做了，因为或许其他的P有很长的<code>goroutine</code>队列要跑，得需要均衡。<br>该如何解决呢？</p>
<p>Go的做法倒也直接，从其他P中偷一半！</p>
<p><img src="/img/csp/stealwork.png"></p>
<p>参考文献：<br><a href="http://morsmachine.dk/go-scheduler">The Go scheduler</a><br>《Go并发编程第一版》</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/04/golang-concurrency-principle/" data-id="clzo46btg0013vajh1hrd1euq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-httpAndGolang" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/11/11/httpAndGolang/" class="article-date">
  <time datetime="2017-11-11T14:18:04.000Z" itemprop="datePublished">2017-11-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/11/httpAndGolang/">Golang的HTTP操作大全</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Golang提供了官方的http包，对于http操作非常的方便和简洁。<br>但是不同于PHP，使用Golang的包来做http操作，还是没有那么”直接“，需要实例化一下这个，实例化一下那个，有点像<code>Java</code>，因此，为了以后书写方便，就把基本的请求写在此。下次用的时候，直接copy就好了。</p>
<h1 id="get-请求"><a href="#get-请求" class="headerlink" title="get 请求"></a>get 请求</h1><p>get请求有好几种方式</p>
<h4 id="直接使用net-http包内的函数请求"><a href="#直接使用net-http包内的函数请求" class="headerlink" title="直接使用net/http包内的函数请求"></a>直接使用<code>net/http</code>包内的函数请求</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;net/http&quot;</span></span><br><span class="line">...</span><br><span class="line">resp, err := http.Get(<span class="string">&quot;http://wwww.baidu.com&quot;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="利用http-client结构体来请求"><a href="#利用http-client结构体来请求" class="headerlink" title="利用http.client结构体来请求"></a>利用http.client结构体来请求</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;net/http&quot;</span></span><br><span class="line">...</span><br><span class="line">clt := http.Client&#123;&#125;</span><br><span class="line">resp, err := clt.Get(<span class="string">&quot;http://wwww.baidu.com&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="最本质的请求方式"><a href="#最本质的请求方式" class="headerlink" title="最本质的请求方式"></a>最本质的请求方式</h4><p>如果稍微看一下源码，就会发现以上两种方式都是用了一下这种最本质的请求方式，使用<code>http.NewRequest</code>函数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">req, err := http.NewRequest(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;http://www.baidu.com&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//然后http.client 结构体的 Do 方法</span></span><br><span class="line"><span class="comment">//http.DefaultClient可以换为另外一个http.client</span></span><br><span class="line">resp, err := http.DefaultClient.Do(req) </span><br></pre></td></tr></table></figure>

<p>Go的get请求面上有好几种请求方式，实则只有一种：</p>
<p>1、使用<code>http.NewRequest</code>函数获得<code>request</code>实体</p>
<p>2、利用<code>http.client</code>结构体的<code>Do</code>方法，将<code>request</code>实体传入<code>Do</code>方法中。</p>
<h1 id="post请求"><a href="#post请求" class="headerlink" title="post请求"></a>post请求</h1><p>和get请求类似，post请求也有多种方法，但本质还是使用了<code>http.NewRequest</code>函数和<code>http.client</code>的<code>Do</code>方法。</p>
<h4 id="使用net-http包带的post方法"><a href="#使用net-http包带的post方法" class="headerlink" title="使用net/http包带的post方法"></a>使用<code>net/http</code>包带的post方法</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;net/url&quot;</span></span><br><span class="line">)</span><br><span class="line">...</span><br><span class="line">data := url.Values&#123;<span class="string">&quot;start&quot;</span>:&#123;<span class="string">&quot;0&quot;</span>&#125;, <span class="string">&quot;offset&quot;</span>:&#123;<span class="string">&quot;xxxx&quot;</span>&#125;&#125;</span><br><span class="line">body := strings.NewReader(data.Encode())</span><br><span class="line">resp, err := http.Post(<span class="string">&quot;xxxxxxx&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>, body)</span><br></pre></td></tr></table></figure>

<p>或者还可以</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;net/url&quot;</span></span><br><span class="line">)</span><br><span class="line">...</span><br><span class="line"><span class="keyword">var</span> r http.Request</span><br><span class="line">r.ParseForm()</span><br><span class="line">r.Form.Add(<span class="string">&quot;xxx&quot;</span>, <span class="string">&quot;xxx&quot;</span>)</span><br><span class="line">body := strings.NewReader(r.Form.Encode())</span><br><span class="line">http.Post(<span class="string">&quot;xxxx&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>, body)</span><br></pre></td></tr></table></figure>
<p>要是还是觉得复杂，还可以：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;net/url&quot;</span></span><br><span class="line">)</span><br><span class="line">...</span><br><span class="line">data := url.Values&#123;<span class="string">&quot;start&quot;</span>:&#123;<span class="string">&quot;0&quot;</span>&#125;, <span class="string">&quot;offset&quot;</span>:&#123;<span class="string">&quot;xxxx&quot;</span>&#125;&#125;</span><br><span class="line">http.PostForm(<span class="string">&quot;xxxx&quot;</span>, data)</span><br></pre></td></tr></table></figure>
<h4 id="使用实例化的http-client的post方法"><a href="#使用实例化的http-client的post方法" class="headerlink" title="使用实例化的http client的post方法"></a>使用实例化的http client的post方法</h4><p>其实本质上直接使用包的函数和实例化的http client是一样的，包的函数底层也仅仅是实例化了一个<code>DefaultClient</code>，然后调用的<code>DefaultClient</code>的方法。下面给出使用实例化的http client的post方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;net/url&quot;</span></span><br><span class="line">)</span><br><span class="line">...</span><br><span class="line">data := url.Values&#123;<span class="string">&quot;start&quot;</span>:&#123;<span class="string">&quot;0&quot;</span>&#125;, <span class="string">&quot;offset&quot;</span>:&#123;<span class="string">&quot;xxxx&quot;</span>&#125;&#125;</span><br><span class="line">body := strings.NewReader(data.Encode())</span><br><span class="line">clt := http.Client&#123;&#125;</span><br><span class="line">resp, err := clt.Post(<span class="string">&quot;xxxxxxx&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>, body)</span><br></pre></td></tr></table></figure>

<p>还有</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;net/url&quot;</span></span><br><span class="line">)</span><br><span class="line">...</span><br><span class="line"><span class="keyword">var</span> r http.Request</span><br><span class="line">r.ParseForm()</span><br><span class="line">r.Form.Add(<span class="string">&quot;xxx&quot;</span>, <span class="string">&quot;xxx&quot;</span>)</span><br><span class="line">body := strings.NewReader(r.Form.Encode())</span><br><span class="line">clt := http.Client&#123;&#125;</span><br><span class="line">clt.Post(<span class="string">&quot;xxxx&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>, body)</span><br></pre></td></tr></table></figure>

<p>简单的，但仅限于form表单</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;net/url&quot;</span></span><br><span class="line">)</span><br><span class="line">...</span><br><span class="line">data := url.Values&#123;<span class="string">&quot;start&quot;</span>:&#123;<span class="string">&quot;0&quot;</span>&#125;, <span class="string">&quot;offset&quot;</span>:&#123;<span class="string">&quot;xxxx&quot;</span>&#125;&#125;</span><br><span class="line">clt := http.Client&#123;&#125;</span><br><span class="line">clt.PostForm(<span class="string">&quot;xxxx&quot;</span>, data)</span><br></pre></td></tr></table></figure>

<h4 id="使用net-http包的NewRequest函数"><a href="#使用net-http包的NewRequest函数" class="headerlink" title="使用net/http包的NewRequest函数"></a>使用<code>net/http</code>包的<code>NewRequest</code>函数</h4><p>其实不管是get方法也好，post方法也好，所有的get、post的的http 请求形式，最终都是会调用<code>net/http</code>包的<code>NewRequest</code>函数，多种多样的请求形式，也仅仅是封装的不同而已。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;net/url&quot;</span></span><br><span class="line">)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">data := url.Values&#123;<span class="string">&quot;start&quot;</span>:&#123;<span class="string">&quot;0&quot;</span>&#125;, <span class="string">&quot;offset&quot;</span>:&#123;<span class="string">&quot;xxxx&quot;</span>&#125;&#125;</span><br><span class="line">body := strings.NewReader(data.Encode())</span><br><span class="line"></span><br><span class="line">req, err := http.NewRequest(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;xxxxx&quot;</span>, body)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>)</span><br><span class="line"></span><br><span class="line">clt := http.Client&#123;&#125;</span><br><span class="line">clt.Do(req)</span><br></pre></td></tr></table></figure>

<h1 id="添加request-header"><a href="#添加request-header" class="headerlink" title="添加request header"></a>添加request header</h1><p><code>net/http</code>包没有封装直接使用请求带header的get或者post方法，所以，要想请求中带header，只能使用<code>NewRequest</code>方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">req, err := http.NewRequest(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;xxxxx&quot;</span>, body)</span><br><span class="line"><span class="comment">//此处还可以写req.Header.Set(&quot;User-Agent&quot;, &quot;myClient&quot;)</span></span><br><span class="line">req.Header.Add(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;myClient&quot;</span>)</span><br><span class="line"></span><br><span class="line">clt := http.Client&#123;&#125;</span><br><span class="line">clt.Do(req)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>有一点需要注意：在添加header操作的时候，<code>req.Header.Add</code>和<code>req.Header.Set</code>都可以，但是在修改操作的时候，只能使用<code>req.Header.Set</code>。<br>这俩方法是有区别的，Golang底层Header的实现是一个<code>map[string][]string</code>，<code>req.Header.Set</code>方法如果原来Header中没有值，那么是没问题的，如果又值，会将原来的值替换掉。而<code>req.Header.Add</code>的话，是在原来值的基础上，再<code>append</code>一个值，例如，原来header的值是“s”，我后<code>req.Header.Add</code>一个”a”的话，变成了<code>[s a]</code>。但是，获取header值的方法<code>req.Header.Get</code>确只取第一个，所以，如果原来有值，重新<code>req.Header.Add</code>一个新值的话，<code>req.Header.Get</code>得到的值不变。</p>
<h1 id="打印response响应"><a href="#打印response响应" class="headerlink" title="打印response响应"></a>打印response响应</h1><p>Golang打印response没有PHP那么爽，哎，编译型语言就是麻烦。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;net/url&quot;</span></span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">)</span><br><span class="line">...</span><br><span class="line">content, err := ioutil.ReadAll(resp.Body)</span><br><span class="line">respBody := <span class="type">string</span>(content)</span><br></pre></td></tr></table></figure>


<h1 id="使用cookie"><a href="#使用cookie" class="headerlink" title="使用cookie"></a>使用cookie</h1><p>Golang提供了cookie的包<code>net/http/cookiejar</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">url, err := url.Parse(<span class="string">&quot;https://www.wukong.com/&quot;</span>)</span><br><span class="line">jar, err := cookiejar.New(<span class="literal">nil</span>)</span><br><span class="line">jar.SetCookies(url, cookies)<span class="comment">//这里的cookies是[]*http.Cookie</span></span><br><span class="line">wukongClt := http.Client&#123;Transport:<span class="literal">nil</span>, Jar:jar&#125;</span><br><span class="line"></span><br><span class="line">wukongClt.Get(<span class="string">&quot;xxxxx&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>文中的<code>cookies</code>类型是<code>[] *http.cookie</code>可以自己实例化，有时候也可以从<code>response</code>中直接使用<code>resp.Cookies()</code>直接拿到。</p>
<p>Golang的cookie是和<code>http.client</code>联系在一起的，作为<code>http.client</code>的一个属性存在。因此，要想在Golang中使用cookie，就必须想办法构造<code>http.client</code></p>
<h1 id="使用代理"><a href="#使用代理" class="headerlink" title="使用代理"></a>使用代理</h1><p>在Golang中使用http proxy，也必须构造自己的<code>http.client</code>，需要将<code>http.client</code>结构体的一个属性<code>Transport</code>自己实例化好。</p>
<h4 id="当使用环境变量-http-proxy或-HTTP-PROXY作为代理时"><a href="#当使用环境变量-http-proxy或-HTTP-PROXY作为代理时" class="headerlink" title="当使用环境变量$http_proxy或$HTTP_PROXY作为代理时"></a>当使用环境变量$http_proxy或$HTTP_PROXY作为代理时</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//从环境变量$http_proxy或$HTTP_PROXY中获取HTTP代理地址</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetTransportFromEnvironment</span><span class="params">()</span></span> (transport *http.Transport) &#123;</span><br><span class="line">	transport = &amp;http.Transport&#123;Proxy : http.ProxyFromEnvironment&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="当使用自己搭建http代理时"><a href="#当使用自己搭建http代理时" class="headerlink" title="当使用自己搭建http代理时"></a>当使用自己搭建http代理时</h4><p>参数<code>proxy_addr</code>即代理服务器IP端口号，例如：”<a href="http://xxx.xxx.xxx.xxx:6000“，注意，必须加上"http">http://xxx.xxx.xxx.xxx:6000“，注意，必须加上&quot;http</a>“</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetTransportFieldURL</span><span class="params">(proxy_addr *<span class="type">string</span>)</span></span> (transport *http.Transport) &#123;</span><br><span class="line">	url_i := url.URL&#123;&#125;</span><br><span class="line">	url_proxy, <span class="type">error</span> := url_i.Parse(*proxy_addr)</span><br><span class="line">	<span class="keyword">if</span> <span class="type">error</span> != <span class="literal">nil</span>&#123;</span><br><span class="line">		fmt.Println(<span class="type">error</span>.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	transport = &amp;http.Transport&#123;Proxy : http.ProxyURL(url_proxy)&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>使用的时候，首先调用函数，拿到对应的<code>transport</code>，即使用<code>GetTransportFieldURL</code>或者<code>GetTransportFieldURL</code>函数，然后构建自定义的<code>http.client</code> :</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ProxyUrl := <span class="string">&quot;http://xxx.xxx.xxx.xxx:6000&quot;</span></span><br><span class="line">transport := GetTransportFieldURL(&amp;ProxyUrl)</span><br><span class="line">clt := http.Client&#123;Transport:transport&#125;</span><br><span class="line"></span><br><span class="line">clt.Get(<span class="string">&quot;http://www.baidu.com&quot;</span>)</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/11/11/httpAndGolang/" data-id="clzo46btk001hvajh1rrn5l1h" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-GolangDetailsTwo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/10/06/GolangDetailsTwo/" class="article-date">
  <time datetime="2017-10-06T08:21:40.000Z" itemprop="datePublished">2017-10-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/06/GolangDetailsTwo/">Golang奇葩点</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文即<a href="https://i6448038.github.io/2017/07/28/GolangDetails/">Go语言的那些坑</a>二。</p>
<h1 id="Golang中函数被看做是值-函数值不可以比较，也不可以作为map的key"><a href="#Golang中函数被看做是值-函数值不可以比较，也不可以作为map的key" class="headerlink" title="Golang中函数被看做是值,函数值不可以比较，也不可以作为map的key"></a>Golang中函数被看做是值,函数值不可以比较，也不可以作为map的key</h1><p>请问以下代码能编译通过吗？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	array := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="function"><span class="keyword">func</span> <span class="params">()</span></span><span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">	array[<span class="function"><span class="keyword">func</span><span class="params">()</span></span><span class="type">int</span>&#123; <span class="keyword">return</span> <span class="number">10</span>&#125;()] = <span class="function"><span class="keyword">func</span><span class="params">()</span></span><span class="type">int</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">12</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(array)</span><br><span class="line">&#125;<span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">**答案：**</span></span><br></pre></td></tr></table></figure>
<p>可以正常编译通过。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">稍作改动，改为如下的情况,还能编译通过吗？</span><br><span class="line"></span><br><span class="line">​```Go</span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main()&#123;</span><br><span class="line">	array := make(map[func ()int]int)</span><br><span class="line"></span><br><span class="line">	array[func()int&#123;return 12&#125;] = 10</span><br><span class="line"></span><br><span class="line">	fmt.Println(array)</span><br><span class="line">&#125;```</span><br><span class="line">**答案：**</span><br></pre></td></tr></table></figure>
<p>不能编译通过。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在Go语言中，函数被看做是第一类值：(first-class values)：函数和其他值一样，可以被赋值，可以传递给函数，可以从函数返回。也可以被当做是一种“函数类型”。例如：有函数``func square(n int) int &#123; return n * n &#125;``，那么就可以赋值``f := square``,而且还可以``fmt.Println(f(3))``（将打印出“9”）。</span><br><span class="line">Go语言函数有两点很特别：</span><br><span class="line">+ 函数值类型不能作为map的key</span><br><span class="line">+ 函数值之间不可以比较，函数值只可以和nil作比较，函数类型的零值是``nil``</span><br><span class="line"></span><br><span class="line"># 匿名函数作用域陷阱</span><br><span class="line"></span><br><span class="line">请看下列代码输出什么？</span><br><span class="line"></span><br><span class="line">​```Go</span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main()&#123;</span><br><span class="line">	var msgs []func()</span><br><span class="line">	array := []string&#123;</span><br><span class="line">		&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	for _, e := range array&#123;</span><br><span class="line"></span><br><span class="line">			msgs = append(msgs, func()&#123;</span><br><span class="line">			fmt.Println(e)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	for _, v := range msgs&#123;</span><br><span class="line">		v()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>答案：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">4</span><br><span class="line">4</span><br><span class="line">4</span><br><span class="line">4</span><br></pre></td></tr></table></figure>

<p>在上述代码中，匿名函数中记录的是循环变量的内存地址，而不是循环变量某一时刻的值。</p>
<p>想要输出1、2、3、4需要改为：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> msgs []<span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line">	array := []<span class="type">string</span>&#123;</span><br><span class="line">		<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;4&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, e := <span class="keyword">range</span> array&#123;</span><br><span class="line">		elem := e</span><br><span class="line">		msgs = <span class="built_in">append</span>(msgs, <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">			fmt.Println(elem)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> msgs&#123;</span><br><span class="line">		v()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实就加了条<code>elem := e</code>看似多余，其实不，这样一来，每次循环后每个匿名函数中保存的就都是当时局部变量<code>elem</code>的值，这样的局部变量定义了4个，每次循环生成一个。</p>
<h1 id="3-int-和-4-int-不算同一个类型"><a href="#3-int-和-4-int-不算同一个类型" class="headerlink" title="[3]int 和 [4]int 不算同一个类型"></a><code>[3]int</code> 和 <code>[4]int</code> 不算同一个类型</h1><p>请看一下代码，请问输出<code>true</code>还是<code>false</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;reflect&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    arrayA := [...]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">    arrayB := [...]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;</span><br><span class="line">    fmt.Println(reflect.TypeOf(arrayA) == reflect.TypeOf(arrayB))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>答案是：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>数组长度是数组类型的一个组成部分，因此[3]int和[4]int是两种不同的数组类型。</p>
<h1 id="数组还可以指定一个索引和对应值的方式来初始化。"><a href="#数组还可以指定一个索引和对应值的方式来初始化。" class="headerlink" title="数组还可以指定一个索引和对应值的方式来初始化。"></a>数组还可以指定一个索引和对应值的方式来初始化。</h1><p>例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    arrayA := [...]<span class="type">int</span>&#123;<span class="number">0</span>:<span class="number">1</span>, <span class="number">2</span>:<span class="number">1</span>, <span class="number">3</span>:<span class="number">4</span>&#125;</span><br><span class="line">    fmt.Println(arrayA)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[1 0 1 4]</span><br></pre></td></tr></table></figure>
<p>有点像<code>PHP</code>数组的感觉，但是又不一样：<code>arrayA</code>的长度是多少呢？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    arrayA := [...]<span class="type">int</span>&#123;<span class="number">0</span>:<span class="number">1</span>, <span class="number">2</span>:<span class="number">1</span>, <span class="number">3</span>:<span class="number">4</span>&#125;</span><br><span class="line">    fmt.Println(<span class="built_in">len</span>(arrayA))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>答案是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4</span><br></pre></td></tr></table></figure>

<p>没错，定义了一个数组长度为4的数组，指定索引的数组长度和最后一个索引的数值相关，例如:<code>r := [...]int&#123;99:-1&#125;</code>就定义了一个含有100个元素的数组<code>r</code>，最后一个元素输出化为-1，其他的元素都是用0初始化。</p>
<h1 id="不能对map中的某个元素进行取地址-操作"><a href="#不能对map中的某个元素进行取地址-操作" class="headerlink" title="不能对map中的某个元素进行取地址&amp;操作"></a>不能对map中的某个元素进行取地址<code>&amp;</code>操作</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a := &amp;ages[<span class="string">&quot;bob&quot;</span>] <span class="comment">// compile error: cannot take address of map element</span></span><br></pre></td></tr></table></figure>

<p>map中的元素不是一个变量，不能对map的元素进行取地址操作，禁止对map进行取地址操作的原因可能是map随着元素的增加map可能会重新分配内存空间，这样会导致原来的地址无效</p>
<h1 id="当map为nil的时候，不能添加值"><a href="#当map为nil的时候，不能添加值" class="headerlink" title="当map为nil的时候，不能添加值"></a>当map为nil的时候，不能添加值</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> sampleMap <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span></span><br><span class="line">    sampleMap[<span class="string">&quot;test&quot;</span>] = <span class="number">1</span></span><br><span class="line">    fmt.Println(sampleMap)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">panic: assignment to entry in nil map</span><br></pre></td></tr></table></figure>

<p>必须使用make或者将map初始化之后，才可以添加元素。</p>
<p>以上代码可以改为:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> sampleMap <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span></span><br><span class="line">    sampleMap = <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span> &#123;</span><br><span class="line">        <span class="string">&quot;test1&quot;</span>:<span class="number">1</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    sampleMap[<span class="string">&quot;test&quot;</span>] = <span class="number">1</span></span><br><span class="line">    fmt.Println(sampleMap)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以正确输出:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">map[test1:1 test:1]</span><br></pre></td></tr></table></figure>

<h1 id="dilbert-Position和-dilbert-Position是不同的"><a href="#dilbert-Position和-dilbert-Position是不同的" class="headerlink" title="&amp;dilbert.Position和(&amp;dilbert).Position是不同的"></a><code>&amp;dilbert.Position</code>和<code>(&amp;dilbert).Position</code>是不同的</h1><p><code>&amp;dilbert.Position</code>相当于<code>&amp;(dilbert.Position)</code>而非<code>(&amp;dilbert).Position</code></p>
<p>请看例子：</p>
<p>请问输出什么？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">type</span> Employee <span class="keyword">struct</span> &#123;</span><br><span class="line">        ID <span class="type">int</span></span><br><span class="line">        Name <span class="type">string</span></span><br><span class="line">        Address <span class="type">string</span></span><br><span class="line">        DoB time.Time</span><br><span class="line">        Position <span class="type">string</span></span><br><span class="line">        Salary <span class="type">int</span></span><br><span class="line">        ManagerID <span class="type">int</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> dilbert Employee</span><br><span class="line"></span><br><span class="line">    dilbert.Position = <span class="string">&quot;123&quot;</span></span><br><span class="line"></span><br><span class="line">    position := &amp;dilbert.Position</span><br><span class="line">    fmt.Println(position)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0xc42006c220</span><br></pre></td></tr></table></figure>

<p>输出的是内存地址</p>
<p>修改一下，把<code>&amp;dilbert.Position</code>改为<code>(&amp;dilbert).Position</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">type</span> Employee <span class="keyword">struct</span> &#123;</span><br><span class="line">        ID <span class="type">int</span></span><br><span class="line">        Name <span class="type">string</span></span><br><span class="line">        Address <span class="type">string</span></span><br><span class="line">        DoB time.Time</span><br><span class="line">        Position <span class="type">string</span></span><br><span class="line">        Salary <span class="type">int</span></span><br><span class="line">        ManagerID <span class="type">int</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> dilbert Employee</span><br><span class="line"></span><br><span class="line">    dilbert.Position = <span class="string">&quot;123&quot;</span></span><br><span class="line"></span><br><span class="line">    position := &amp;dilbert.Position</span><br><span class="line">    fmt.Println(position)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">123</span><br></pre></td></tr></table></figure>

<h1 id="Go语言中函数返回的是值的时候，不能赋值"><a href="#Go语言中函数返回的是值的时候，不能赋值" class="headerlink" title="Go语言中函数返回的是值的时候，不能赋值"></a>Go语言中函数返回的是值的时候，不能赋值</h1><p>请看下面例子:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Employee <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID <span class="type">int</span></span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">    Address <span class="type">string</span></span><br><span class="line">    DoB time.Time</span><br><span class="line">    Position <span class="type">string</span></span><br><span class="line">    Salary <span class="type">int</span></span><br><span class="line">    ManagerID <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">EmployeeByID</span><span class="params">(id <span class="type">int</span>)</span></span> Employee &#123;</span><br><span class="line">    <span class="keyword">return</span> Employee&#123;ID:id&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    EmployeeByID(<span class="number">1</span>).Salary = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请问能编译通过吗？</p>
<p>运行，输出报错：<code>cannot assign to EmployeeByID(1).Salary</code></p>
<p>在本例子中，函数<code>EmployeeById(id int)</code>返回的是值类型的，它的取值<code>EmployeeByID(1).Salary</code>也是一个值类型；值类型是什么概念？值类型就是和赋值语句<code>var a = 1</code>或<code>var a = hello world</code>等号<code>=</code>右边的<code>1</code>、<code>Hello world</code>是一个概念，他是不能够被赋值的，只有变量能够被赋值。</p>
<p>修改程序如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Employee <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID <span class="type">int</span></span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">    Address <span class="type">string</span></span><br><span class="line">    DoB time.Time</span><br><span class="line">    Position <span class="type">string</span></span><br><span class="line">    Salary <span class="type">int</span></span><br><span class="line">    ManagerID <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">EmployeeByID</span><span class="params">(id <span class="type">int</span>)</span></span> Employee &#123;</span><br><span class="line">    <span class="keyword">return</span> Employee&#123;ID:id&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> a = EmployeeByID(<span class="number">1</span>)</span><br><span class="line">    a.Salary = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就可以编译通过了</p>
<h1 id="在声明方法时，如果一个类型名称本身就是一个指针的话，不允许出现在方法的接收器中"><a href="#在声明方法时，如果一个类型名称本身就是一个指针的话，不允许出现在方法的接收器中" class="headerlink" title="在声明方法时，如果一个类型名称本身就是一个指针的话，不允许出现在方法的接收器中"></a>在声明方法时，如果一个类型名称本身就是一个指针的话，不允许出现在方法的接收器中</h1><p>请看下面的例子，请问会编译通过吗？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> littleGirl <span class="keyword">struct</span>&#123;</span><br><span class="line">	Name <span class="type">string</span></span><br><span class="line">	Age <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> girl *littleGirl</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(this girl)</span></span> changeName(name <span class="type">string</span>)&#123;</span><br><span class="line">	this.Name = name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	littleGirl := girl&#123;Name:<span class="string">&quot;Rose&quot;</span>, Age:<span class="number">1</span>&#125;</span><br><span class="line">	</span><br><span class="line">	girl.changeName(<span class="string">&quot;yoyo&quot;</span>)</span><br><span class="line">	fmt.Println(littleGirl)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>答案:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">不能编译通过，会提示“invalid receiver type girl(girl is a pointer type)”</span><br></pre></td></tr></table></figure>
<p>Go语言中规定，只有类型（Type）和指向他们的指针（*Type）才是可能会出现在接收器声明里的两种接收器，为了避免歧义，明确规定，如果一个类型名本身就是一个指针的话，是不允许出现在接收器中的。</p>
<h1 id="函数允许nil指针作为参数，也允许用nil作为方法的接收器"><a href="#函数允许nil指针作为参数，也允许用nil作为方法的接收器" class="headerlink" title="函数允许nil指针作为参数，也允许用nil作为方法的接收器"></a>函数允许nil指针作为参数，也允许用nil作为方法的接收器</h1><p>请看下面的例子，请问能编译通过吗？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> littleGirl <span class="keyword">struct</span>&#123;</span><br><span class="line">	Name <span class="type">string</span></span><br><span class="line">	Age <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(this littleGirl)</span></span> changeName(name <span class="type">string</span>)&#123;</span><br><span class="line">	fmt.Println(name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	little := littleGirl&#123;Name:<span class="string">&quot;Rose&quot;</span>, Age:<span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line">	little = <span class="literal">nil</span></span><br><span class="line">	little.changeName(<span class="string">&quot;yoyo&quot;</span>)</span><br><span class="line">	fmt.Println(little)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>答案:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">不能编译通过，显示&quot;cannot use nil as type littleGirl in assignment&quot;</span><br></pre></td></tr></table></figure>

<p>Go语言中，允许方法用nil指针作为其接收器，也允许函数将nil指针作为参数。而上述代码中的<code>littleGirl</code>不是指针类型，改为<code>*littleGirl</code>，然后变量<code>little</code>赋值为<code>&amp;littleGirl&#123;Name:&quot;Rose&quot;, Age:1&#125;</code>就可以编译通过了。<br>并且，nil对于对象来说是合法的零值的时候，比如map或者slice，也可以编译通过并正常运行。</p>
<h1 id="Golang的时间格式化"><a href="#Golang的时间格式化" class="headerlink" title="Golang的时间格式化"></a>Golang的时间格式化</h1><p>不同于PHP的<code>date(&quot;Y-m-d H:i:s&quot;, time())</code>，Golang的格式化奇葩的很，不能使用诸如<code>Y-m-d H:i:s</code>的东西，而是使用<code>2006-01-02 15:04:05</code>这个时间的格式，请记住这个时间，据说这是Golang的诞生时间。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">time := time.Now()</span><br><span class="line"></span><br><span class="line">time.Format(<span class="string">&quot;20060102&quot;</span>) <span class="comment">//相当于Ymd</span></span><br><span class="line"></span><br><span class="line">time.Format(<span class="string">&quot;2006-01-02&quot;</span>)<span class="comment">//相当于Y-m-d</span></span><br><span class="line"></span><br><span class="line">time.Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>)<span class="comment">//相当于Y-m-d H:i:s</span></span><br><span class="line"></span><br><span class="line">time.Format(<span class="string">&quot;2006-01-02 00:00:00&quot;</span>)<span class="comment">//相当于Y-m-d 00:00:00</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/10/06/GolangDetailsTwo/" data-id="clzo46bt20004vajhdv0ie17w" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-十分钟学会正则表达式" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/27/%E5%8D%81%E5%88%86%E9%92%9F%E5%AD%A6%E4%BC%9A%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="article-date">
  <time datetime="2017-08-27T14:29:09.000Z" itemprop="datePublished">2017-08-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/27/%E5%8D%81%E5%88%86%E9%92%9F%E5%AD%A6%E4%BC%9A%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">十分钟学会正则表达式</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>正则表达式用处挺广的，主要用于处理字符串。</p>
<h2 id="正则引擎"><a href="#正则引擎" class="headerlink" title="正则引擎"></a>正则引擎</h2><p>想要在计算机语言中使用正则表达式，那么这门计算机语言必须要利用正则引擎去实现相应的正则库。主要的正则引擎分为以下两类：</p>
<ul>
<li>DFA 确定性的状态机。不使用”回溯”，效率高，但是支持的正则表达式语法有限。</li>
<li>NFA 非确定性状态机。构造简单，使用”回溯算法”，支持大多数的正则语法，是目前使用最广泛的正则引擎，大多数计算机语言例如Java、PHP、Ruby、Python等都是使用的NFA正则引擎。</li>
</ul>
<h2 id="语言实现"><a href="#语言实现" class="headerlink" title="语言实现"></a>语言实现</h2><p>不同的语言对正则的实现不同，暴露出来的方法也不同，但方法的作用其实都是大同小异，这里用PHP语言做例子。</p>
<h4 id="匹配字符串"><a href="#匹配字符串" class="headerlink" title="匹配字符串"></a>匹配字符串</h4><ul>
<li><code>preg_match(string $pattern, string $subject[, array &amp;$matches])</code> 使用很频繁。函数返回匹配到的结果的次数。只匹配一次，参数<code>matches</code>只返回第一条结果。</li>
<li><code>preg_match_all(string $pattern, string $subject[, array &amp;$matches])</code> 使用很频繁。函数返回匹配到的结果的次数。参数<code>matches</code>只返回所有结果。</li>
</ul>
<h4 id="替换字符串或数组"><a href="#替换字符串或数组" class="headerlink" title="替换字符串或数组"></a>替换字符串或数组</h4><ul>
<li><code>preg_replace($pattern, $replacement, $subject)</code> 返回匹配过滤后的字符串或者数组。</li>
<li><code>preg_filter($pattern, $replacement, $subject)</code>返回匹配过滤后的字符串或者数组。</li>
</ul>
<p>这俩函数，都可以替换字符串，在字符串替换中，俩函数用法完全一致。</p>
<p>这俩函数，不仅可以替换字符串，还可以替换数组！在替换数组的时候，<code>pre_filter</code>会过滤掉没有匹配到的内容，而<code>pre_replace</code>不会，这就是他俩的唯一区别。</p>
<h4 id="替换数组"><a href="#替换数组" class="headerlink" title="替换数组"></a>替换数组</h4><ul>
<li><code>preg_grep(string $pattern, array $input[, int flags = 0])</code> 返回匹配模式的数组条目。阉割版本的<code>preg_filter</code></li>
</ul>
<h4 id="正则运算符转义"><a href="#正则运算符转义" class="headerlink" title="正则运算符转义"></a>正则运算符转义</h4><p>对一个字符串中的正则表达式的运算符：”. \ + * ? [ ] ^ $ ( ) { } &#x3D; ! &lt; &gt; | : -“进行转义，转义成非正则表达式的运算符，否则正则表达式会认为其为运算符。</p>
<ul>
<li><code>preg_quote(string $str[, string $delimiter = null ])</code> 转义正则表达式字符串。返回转义后的字符串。</li>
</ul>
<h2 id="正则表达式语法"><a href="#正则表达式语法" class="headerlink" title="正则表达式语法"></a>正则表达式语法</h2><p>你可以把正则表达式当做一门简单的语言来看，但是它的语法显然比一般的计算机语言要简单一些。</p>
<h4 id="界定符"><a href="#界定符" class="headerlink" title="界定符"></a>界定符</h4><p>指定正则表达式的开始和结束，可以当成是计算机语言中的大括号<code>&#123;</code>和<code>&#125;</code>。一般有三种表现方式：</p>
<ul>
<li>斜杠。例如<code>/[0-9]/</code>。这是最常用的方式，在PHP中，推荐使用这种方式。</li>
<li>井号。例如<code>#[0-9]</code>。</li>
<li>大括号。例如<code>&#123;[0-9]&#125;</code>。在正则表达式中，大括号还有其他作用，所以这种方式不推荐使用。</li>
</ul>
<h4 id="原子"><a href="#原子" class="headerlink" title="原子"></a>原子</h4><p>正则表达式中最小的匹配单位，其实就是字符串中的字符。主要分为两大类：</p>
<p>可见原子:</p>
<p>肉眼能够看见的字符。</p>
<ul>
<li>标点符号。例如：”_ ? . ;,“等等</li>
<li>英文字母数字。例如：”a-z,A-Z,0-9“</li>
<li>汉字、日文、阿拉伯文等其他语言文字</li>
<li>数理化公式符号。例如：”∩ ∪ π Ω “等等</li>
<li>其他可见字符</li>
</ul>
<p>由于某些字符在正则表达式中属于特殊字符，那么在书写这类特殊字符的时候，应该注意要加上反斜杠<code>\</code>，例如如果匹配<code>^</code>直接写<code>/^/</code>肯定不行，如果加上反斜杠，就可以了。<code>\^</code></p>
<p>不可见原子:</p>
<p>肉眼看不到的。</p>
<ul>
<li>空格。</li>
<li>换行符<code>\n</code></li>
<li>回车符<code>\r</code></li>
<li>制表符<code>\t</code>。其实就是按一下键盘tab键出来的</li>
<li>其他不可见字符</li>
</ul>
<h4 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h4><p>定义原子的筛选方式，队员原子进行归类，简化正则表达式的书写。</p>
<ul>
<li><code>|</code> 匹配两个或者多个分支选择。 和计算机语言中的含义是一样的:<code>或者</code></li>
<li><code>[]</code> 匹配方括号中的任意一个原子。</li>
<li><code>[^]</code> 匹配除方括号之外的任意字符串。</li>
<li><code>.</code> 匹配除<code>\n</code>之外的任何单个字符。要匹配包括<code>\n</code>在内的任何字符，请使用象<code>[.\n]</code>的模式。</li>
<li><code>\d</code> 十进制数字，等同于<code>[0-9]</code></li>
<li><code>\D</code> 匹配任意一个非十进制的数字，等同于<code>[^0-9]</code></li>
<li><code>\s</code> 匹配任意一个不可见原子。等同于<code>[\f\n\r\t\v]</code></li>
<li><code>\S</code> 匹配一个可见原子。等同于<code>[^\f\n\r\t\v]</code></li>
<li><code>\w</code> 匹配任意数字、字母或下划线。既<code>[0-9a-zA-Z_]</code></li>
<li><code>\W</code> 匹配任意非数字、字母或下划线。即<code>[^0-9a-zA-Z_]</code></li>
</ul>
<h4 id="量词"><a href="#量词" class="headerlink" title="量词"></a>量词</h4><p>表示某一个原子<strong>连续</strong>出现的数量。</p>
<ul>
<li><code>&#123;n&#125;</code> 表示前面的原子恰好出现n次</li>
<li><code>&#123;n,&#125;</code> 表示前面的原子最少出现n次 </li>
<li><code>&#123;n,m&#125;</code> 表示前面的原子最少出现n此，最多出现m次</li>
<li><code>*</code> 匹配0次、1次、或者多次。等同于<code>&#123;0,&#125;</code></li>
<li><code>+</code> 一次或者多次。等同于<code>&#123;1,&#125;</code></li>
<li><code>?</code> 0次数或者1次。等同于<code>&#123;0,1&#125;</code></li>
</ul>
<h4 id="边界控制"><a href="#边界控制" class="headerlink" title="边界控制"></a>边界控制</h4><ul>
<li><code>^</code> 匹配字符串开始的位置。即”必须以……为开头”</li>
<li><code>$</code> 匹配字符串结束的位置。即”必须以……为结尾”</li>
</ul>
<h4 id="模式单元"><a href="#模式单元" class="headerlink" title="模式单元"></a>模式单元</h4><p>将模式单元中的括号及其正则表达式当做是一个原子来看待。</p>
<ul>
<li><code>()</code> 匹配其中的整体为一个原子。</li>
</ul>
<h4 id="修正模式"><a href="#修正模式" class="headerlink" title="修正模式"></a>修正模式</h4><p>给正则表达式的匹配过程添加一种匹配模式</p>
<ul>
<li><code>U</code> 加<code>U</code>是懒惰匹配，不加<code>U</code>是默认的贪婪匹配。</li>
<li><code>i</code> 忽略英文字母大小写。</li>
<li><code>x</code> 忽略空白。（包括空格和按tab键输出的制表符）</li>
<li><code>s</code> 让元字符<code>.</code>匹配包括换行符在内的所有字符。</li>
<li><code>e</code> <code>preg_replace()</code>在替换字符串中对逆向引用作正常的替换。简单的说，就是PHP会把replace的结果当做PHP代码。（替换字符串要符合php的语法规范）<br>例如：<code>echo preg_replace(&#39;/(\d+),(\d+)/e&#39;, &#39;$1+$2&#39;, &#39;2,3&#39;);</code>会输出<code>5</code>。</li>
</ul>
<p>书写方式为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pattern</span> = <span class="string">&#x27;/hello World/U&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$pattern</span> = <span class="string">&#x27;/hello World/i&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$pattern</span> = <span class="string">&#x27;/hello World/Ui&#x27;</span><span class="comment">//可以任意组合</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>









      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/08/27/%E5%8D%81%E5%88%86%E9%92%9F%E5%AD%A6%E4%BC%9A%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" data-id="clzo46bty002uvajhhxcf6iy7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">正则表达式</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-PHP性能优化" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/13/PHP%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="article-date">
  <time datetime="2017-08-13T07:13:49.000Z" itemprop="datePublished">2017-08-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/13/PHP%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">PHP性能优化</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>PHP虽然是世界上最好的语言，但是它本身作为一门脚本语言，其运行效率一直被人们所诟病。</p>
<p>作为以PHP为开发语言的应用程序而言，PHP程序的性能能影响到整个架构性能的百分之30左右，不会超过百分之50，其余的是硬件的、操作系统的、存储的等等其他性能优化；因此，PHP程序的性能好坏，对于整个系统架构而言，还是很重要的。</p>
<p>PHP的性能优化分为一下三个层次：</p>
<img src='/img/php/php1.png' />

<p>这三个层次性能优化的难度依次上升，效果却依次降低。在此，我们重点讨论前两种层次。</p>
<h1 id="PHP代码的优化"><a href="#PHP代码的优化" class="headerlink" title="PHP代码的优化"></a>PHP代码的优化</h1><h2 id="多使用PHP内置的函数，少使用PHP代码，且精简PHP代码"><a href="#多使用PHP内置的函数，少使用PHP代码，且精简PHP代码" class="headerlink" title="多使用PHP内置的函数，少使用PHP代码，且精简PHP代码"></a>多使用PHP内置的函数，少使用PHP代码，且精简PHP代码</h2><p>PHP的执行流程为：<br><img src='/img/php/php_flow.png' /></p>
<p>这个原理是很简单的，PHP是解释型语言，PHP代码得经过好几步转化才能变成最终的机器码，假如PHP代码写的很多，不够精简，转化的步骤就会变长，自然会影响PHP程序的性能。而PHP内置的函数是由C语言编写的，运行速度自然快。</p>
<h2 id="PHP内置函数的执行效率也有优先级，可以尽量使用快的"><a href="#PHP内置函数的执行效率也有优先级，可以尽量使用快的" class="headerlink" title="PHP内置函数的执行效率也有优先级，可以尽量使用快的"></a>PHP内置函数的执行效率也有优先级，可以尽量使用快的</h2><p>这个原因也是显而易见的，虽然都是C语言写的程序，但是C实现的方式还是不同的，有的实现方式快一些，有的实现的慢一些，所以调用快的效率肯定会高一点。<br>例如：</p>
<ul>
<li><code>array_key_exists</code>效率要比<code>in_array</code>高</li>
<li><code>require</code>比<code>require_once </code>效率高</li>
<li>单引号<code>&#39;&#39;</code>比双引号<code>&quot;&quot;</code>效率高</li>
</ul>
<h2 id="减少PHP魔法函数的使用"><a href="#减少PHP魔法函数的使用" class="headerlink" title="减少PHP魔法函数的使用"></a>减少PHP魔法函数的使用</h2><p>PHP的魔法函数用起来很爽，但是既然用的这么爽，那么PHP在底层肯定帮你做了诸多事情，做的这么一堆事情，不能不消耗性能吧。<br>PHP魔法函数为了让程序员爽，在语言级别帮程序猿做了很多，会带啦性能开销，我们应该看情况酌情使用。</p>
<h2 id="不要使用错误抑制符"><a href="#不要使用错误抑制符" class="headerlink" title="不要使用错误抑制符@"></a>不要使用错误抑制符<code>@</code></h2><p><code>@</code>错误抑制符这玩意儿的实现原理和魔法函数差不多，都是方便了程序猿苦了自己；原理也很简单，就是在添加了错误@符号的前面和后面添加了Opcode，Opcode的作用就是和<code>error_reporting</code>忽略错误一样一样的，然后在添加了@符号的代码之后再添加上一些Opcode，将错误等级恢复。</p>
<p>可以用PHP的Opcode查看扩展<code>vld</code>来查看添加了@符号的代码情况。(<code>vld</code>的使用也很简单，就俩指令<code>vld.active=1</code>和<code>vld.execute=0.</code>, <code>vld.active=1</code>表示想要用扩展，<code>vld.execute=0.</code>表示只是查看Opcode代码，<code>vld.execute=1.</code>表示要执行php程序。&#96;&#96;php -vld.active&#x3D;1 -vld.execute&#x3D;0 xxx.php)</p>
<h2 id="合理使用PHP内存，释放掉没用的变量"><a href="#合理使用PHP内存，释放掉没用的变量" class="headerlink" title="合理使用PHP内存，释放掉没用的变量"></a>合理使用PHP内存，释放掉没用的变量</h2><p>要尽量合理的使用内存，例如：</p>
<ul>
<li>从数据库中取字段，只取某个字段，就不要取出全部字段。 select xxx 和 select * 的区别</li>
<li>读取文件，文件使用完后，文件close的问题</li>
<li>使用<code>unset</code>及时释放掉无用的变量。（但是也会有unset不掉的情况）</li>
</ul>
<h2 id="尽量减少使用正则表达式"><a href="#尽量减少使用正则表达式" class="headerlink" title="尽量减少使用正则表达式"></a>尽量减少使用正则表达式</h2><p>正则表达式需要回溯，当正则表达式越长，它回溯的开销就会越大，优化表达式也是个技术活儿，所以建议尽量使用PHP内置的处理函数来替代。</p>
<h2 id="避免循环内做重复的计算"><a href="#避免循环内做重复的计算" class="headerlink" title="避免循环内做重复的计算"></a>避免循环内做重复的计算</h2><p>例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$str</span> = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$str</span>); <span class="variable">$i</span> ++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>strlen($str)</code>是不是被重复计算了？有意义吗？写在外边不好吗？</p>
<h2 id="避免数据密集型计算"><a href="#避免数据密集型计算" class="headerlink" title="避免数据密集型计算"></a>避免数据密集型计算</h2><p>PHP是由C语言来实现的，PHP本身在处理一些计算的时候，额外的开销是很大的，例如它的变量寄存、语言处理，都需要C来实现…PHP的“慢”，不是由于一些特性而“慢”，是整体就慢。所以在处理一些大批量数据例如大批量日志处理，大批量数据分析的时候，是十分不适合的，和C等语言比起来不是一个数量级。</p>
<p>PHP的语言特性决定了PHP不适合做大数据量的计算。<br>PHP适合做的事：<br><img src='/img/php/php_duty.png' /></p>
<p>PHP适合做一个纽带，适合做一些字符串、文本处理。</p>
<h2 id="使用Opcode-cache"><a href="#使用Opcode-cache" class="headerlink" title="使用Opcode cache"></a>使用Opcode cache</h2><p>Opcode是整个PHP中最接近机器码的地方，假如我们对Opcode做一下缓存，就节约了PHP代码解析、编译的开销，在此，我们可以使用一些扩展来对Opcode进行缓存</p>
<ul>
<li><code>APC</code>。（已经不更新）</li>
<li>鸟哥的<code>yac</code>。</li>
</ul>
<h1 id="PHP周边性能优化"><a href="#PHP周边性能优化" class="headerlink" title="PHP周边性能优化"></a>PHP周边性能优化</h1><img src='/img/php/php_around.png' />

<p>以上就是PHP周边的环境。只有PHP周边的环境也得到了很好的性能优化，才能将PHP的系统架构发挥到极致。</p>
<h2 id="不要使用过多的IO"><a href="#不要使用过多的IO" class="headerlink" title="不要使用过多的IO"></a>不要使用过多的IO</h2><p>PHP场景的性能开销次序为：<code>读取内存 &lt; 读取数据库 &lt; 读取文件 &lt; 读取网络数据</code></p>
<p>PHP是不适合编写IO密集型的程序。</p>
<h2 id="优化网络请求"><a href="#优化网络请求" class="headerlink" title="优化网络请求"></a>优化网络请求</h2><h3 id="设置超时时间"><a href="#设置超时时间" class="headerlink" title="设置超时时间"></a>设置超时时间</h3><ul>
<li>连接超时 200ms</li>
<li>读超时 800ms</li>
<li>写超时 500ms</li>
</ul>
<h3 id="将串行请求并行化"><a href="#将串行请求并行化" class="headerlink" title="将串行请求并行化"></a>将串行请求并行化</h3><ul>
<li>使用<code>curl_multi_*()</code>的函数代替<code>curl</code></li>
<li>使用<code>swoole</code>扩展(比 <code>curl_multi</code>还要好)</li>
</ul>
<h2 id="合理的将PHP接口输出压缩"><a href="#合理的将PHP接口输出压缩" class="headerlink" title="合理的将PHP接口输出压缩"></a>合理的将PHP接口输出压缩</h2><p>使用<code>gzip</code>可以将PHP接口输出压缩，提高我们的IO，但是压缩的过程需要额外的计算消耗，需要消耗部分CPU性能，需要合理使用；当数据量小于几十kb的时候，用<code>gzip</code>还不如不用，当<code>gzip</code>数据大于100k的时候，压缩是合理的，而且压缩的程度还和数据重复的个数有关，如果重复的多，<code>gizp</code>就压缩的小，如果重复的少，<code>gzip</code>压缩的就稍微大点儿。</p>
<h1 id="最后的解决方案"><a href="#最后的解决方案" class="headerlink" title="最后的解决方案"></a>最后的解决方案</h1><h2 id="使用性能优化分析工具"><a href="#使用性能优化分析工具" class="headerlink" title="使用性能优化分析工具"></a>使用性能优化分析工具</h2><ul>
<li>Facebook的<code>XHPorf</code></li>
<li>压力测试工具Apache的<code>ab</code></li>
<li>opcode代码分析工具<code>vld</code></li>
</ul>
<h2 id="用PHP扩展代替部分逻辑"><a href="#用PHP扩展代替部分逻辑" class="headerlink" title="用PHP扩展代替部分逻辑"></a>用PHP扩展代替部分逻辑</h2><p>这个不用多说，很多大公司都是这么做的。<br>把很多PHP的library做成<code>.so</code>文件。</p>
<h2 id="使用PHP7"><a href="#使用PHP7" class="headerlink" title="使用PHP7"></a>使用PHP7</h2><p><code>HHVM</code>是由Facebook推出的,用来提升PHP<code>runtime</code>效率的，效果十分明显。但是，就PHP7而言，官方觉得PHP7的engine更胜一筹，所以，如果想要整体提高性能，升级PHP7还是必要的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/08/13/PHP%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" data-id="clzo46bt9000gvajhbahx7rrg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/" rel="tag">php</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-GolangDetails" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/28/GolangDetails/" class="article-date">
  <time datetime="2017-07-28T10:38:37.000Z" itemprop="datePublished">2017-07-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/28/GolangDetails/">Go语言的那些坑</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Golang是我最喜欢的一门语言，它简洁、高效、易学习、开发效率高、还可以编译成机器码…<br>虽然它一出世，就饱受关注，而且现在在市面上逐渐流行开来，但是，它毕竟是一门新兴语言，还有很多让人不太习惯的地方（即坑，(<em>^__^</em>)），我作为新手，一边学习，一边踩坑，希望对其他人有借鉴作用。s</p>
<h1 id="文件名字不要轻易以-test-go为结尾"><a href="#文件名字不要轻易以-test-go为结尾" class="headerlink" title="文件名字不要轻易以__test.go为结尾"></a>文件名字不要轻易以<code>__test.go</code>为结尾</h1><p>Golang的source文件的命名和其他语言本无差别，但是Golang自带<code>Unit test</code>，它的<code>unit test</code>有个小规范：所有<code>unit test</code>文件都要以<code>__test.go</code>为结尾！<br>所以，当你命名一个非<code>unit test</code>文件为XXX_test.go，而且执意要编译时，就会报错：<code>no buildable Go source files in XXXXXX(你的文件路径)</code>。<br>所以，切记，以<code>__test.go</code>为结尾的都是<code>unit test</code>的文件，且切记不要把<code>unit test</code>文件和普通Go文件放到一起，一定要把<code>unit test</code>文件集体放到一个目录中，否则会编译不过的。</p>
<h1 id="语句fmt-Println-这里是汉字-字符串变量-字符串变量的值打印不出来的问题"><a href="#语句fmt-Println-这里是汉字-字符串变量-字符串变量的值打印不出来的问题" class="headerlink" title="语句fmt.Println(&quot;这里是汉字:&quot; + 字符串变量) 字符串变量的值打印不出来的问题"></a>语句<code>fmt.Println(&quot;这里是汉字:&quot; + 字符串变量)</code> 字符串变量的值打印不出来的问题</h1><p>现有如下程序：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">    m1 := getString()</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;现在是:&quot;</span> + m1)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getString</span><span class="params">()</span></span><span class="type">string</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;abd&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行指令<code>go run test.go</code></p>
<img src="/img/go_keng/console.png">

<p>但是单独打印变量<code>m1</code>却可以正常显示</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">    m1 := getString()</span><br><span class="line"></span><br><span class="line">    fmt.Println(m1)</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;现在是:&quot;</span> + m1)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getString</span><span class="params">()</span></span><span class="type">string</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;abd&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/img/go_keng/console1.png">

<p>这是为什么呢？很奇怪啊！<br>其实这要怪IDE，我的IDE是phpstorm + Golang插件包，IDE自带的console对中文的支持很不友好，带中文的字符串打印出来后，容易显示不全，其实通过<code>terminal</code>打印出来，是正确的！</p>
<img src="/img/go_keng/terminal.png">

<h1 id="多个defer出现的时候，多个defer之间按照LIFO（后进先出）的顺序执行"><a href="#多个defer出现的时候，多个defer之间按照LIFO（后进先出）的顺序执行" class="headerlink" title="多个defer出现的时候，多个defer之间按照LIFO（后进先出）的顺序执行"></a>多个<code>defer</code>出现的时候，多个<code>defer</code>之间按照LIFO（后进先出）的顺序执行</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>对应的输出是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">3</span><br><span class="line">2</span><br><span class="line">1</span><br></pre></td></tr></table></figure>


<h1 id="panic中可以传任何值，不仅仅可以传string"><a href="#panic中可以传任何值，不仅仅可以传string" class="headerlink" title="panic中可以传任何值，不仅仅可以传string"></a><code>panic</code>中可以传任何值，不仅仅可以传string</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> r := <span class="built_in">recover</span>();r != <span class="literal">nil</span>&#123;</span><br><span class="line">            fmt.Println(r)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">panic</span>([]<span class="type">int</span>&#123;<span class="number">12312</span>&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[12312]</span><br></pre></td></tr></table></figure>

<h1 id="用for-range来遍历数组或者map的时候，被遍历的指针是不变的，每次遍历仅执行struct值的拷贝"><a href="#用for-range来遍历数组或者map的时候，被遍历的指针是不变的，每次遍历仅执行struct值的拷贝" class="headerlink" title="用for range来遍历数组或者map的时候，被遍历的指针是不变的，每次遍历仅执行struct值的拷贝"></a>用<code>for range</code>来遍历数组或者map的时候，被遍历的指针是不变的，每次遍历仅执行struct值的拷贝</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> student <span class="keyword">struct</span>&#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">    Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> stus []student</span><br><span class="line"></span><br><span class="line">    stus = []student&#123;</span><br><span class="line">        &#123;Name:<span class="string">&quot;one&quot;</span>, Age: <span class="number">18</span>&#125;,</span><br><span class="line">        &#123;Name:<span class="string">&quot;two&quot;</span>, Age: <span class="number">19</span>&#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]*student)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, v := <span class="keyword">range</span> stus&#123;</span><br><span class="line">        data[i] = &amp;v   <span class="comment">//应该改为：data[i] = &amp;stus[i]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, v := <span class="keyword">range</span> data&#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;key=%d, value=%v \n&quot;</span>, i,v)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，结果输出为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">key=0, value=&amp;&#123;two 19&#125; </span><br><span class="line">key=1, value=&amp;&#123;two 19&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Go中没有继承！没有继承！Go中是叫组合！是组合！"><a href="#Go中没有继承！没有继承！Go中是叫组合！是组合！" class="headerlink" title="Go中没有继承！没有继承！Go中是叫组合！是组合！"></a>Go中没有继承！没有继承！Go中是叫组合！是组合！</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> student <span class="keyword">struct</span>&#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">    Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *student)</span></span> love()&#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;love&quot;</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *student)</span></span> like()&#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;like first&quot;</span>)</span><br><span class="line">    p.love()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> boy <span class="keyword">struct</span> &#123;</span><br><span class="line">    student</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b * boy)</span></span> love()&#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;hate&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    b := boy&#123;&#125;</span><br><span class="line"></span><br><span class="line">    b.like()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">like first</span><br><span class="line">love</span><br></pre></td></tr></table></figure>

<h1 id="不管运行顺序如何，当参数为函数的时候，要先计算参数的值"><a href="#不管运行顺序如何，当参数为函数的时候，要先计算参数的值" class="headerlink" title="不管运行顺序如何，当参数为函数的时候，要先计算参数的值"></a>不管运行顺序如何，当参数为函数的时候，要先计算参数的值</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    a := <span class="number">1</span></span><br><span class="line">    <span class="keyword">defer</span> <span class="built_in">print</span>(function(a))</span><br><span class="line">    a = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">function</span><span class="params">(num <span class="type">int</span>)</span></span> <span class="type">int</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> num</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">print</span><span class="params">(num <span class="type">int</span>)</span></span>&#123;</span><br><span class="line">    fmt.Println(num)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1</span><br></pre></td></tr></table></figure>

<h1 id="注意是struct的函数，还是-struct的函数"><a href="#注意是struct的函数，还是-struct的函数" class="headerlink" title="注意是struct的函数，还是* struct的函数"></a>注意是<code>struct</code>的函数，还是<code>* struct</code>的函数</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> people <span class="keyword">interface</span> &#123;</span><br><span class="line">    speak()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> student <span class="keyword">struct</span>&#123;</span><br><span class="line">    name <span class="type">string</span></span><br><span class="line">    age <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(stu *student)</span></span> speak()&#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;I am a student, I am &quot;</span>, stu.age)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> p people</span><br><span class="line">    p = student&#123;name:<span class="string">&quot;RyuGou&quot;</span>, age:<span class="number">12</span>&#125; <span class="comment">//应该改为 p = &amp;student&#123;name:&quot;RyuGou&quot;, age:12&#125;</span></span><br><span class="line">    p.speak()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cannot use student literal (type student) as type people in assignment:</span><br><span class="line">student does not implement people (speak method has pointer receiver)</span><br></pre></td></tr></table></figure>

<h1 id="make-chan-int-和-make-chan-int-1-是不一样的"><a href="#make-chan-int-和-make-chan-int-1-是不一样的" class="headerlink" title="make(chan int) 和 make(chan int, 1)是不一样的"></a><code>make(chan int)</code> 和 <code>make(chan int, 1)</code>是不一样的</h1><p><code>chan</code>一旦被写入数据后，当前<code>goruntine</code>就会被阻塞，知道有人接收才可以（即 “ &lt;- ch”），如果没人接收，它就会一直阻塞着。而如果chan带一个缓冲，就会把数据放到缓冲区中，直到缓冲区满了，才会阻塞</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>) <span class="comment">//改为 ch := make(chan int, 1) 就好了</span></span><br><span class="line"></span><br><span class="line">    ch &lt;- <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatal error: all goroutines are asleep - deadlock!</span><br></pre></td></tr></table></figure>

<h1 id="golang-的-select-的功能和-select-poll-epoll-相似，-就是监听-IO-操作，当-IO-操作发生时，触发相应的动作。"><a href="#golang-的-select-的功能和-select-poll-epoll-相似，-就是监听-IO-操作，当-IO-操作发生时，触发相应的动作。" class="headerlink" title="golang 的 select 的功能和 select, poll, epoll 相似， 就是监听 IO 操作，当 IO 操作发生时，触发相应的动作。"></a>golang 的 select 的功能和 select, poll, epoll 相似， 就是监听 IO 操作，当 IO 操作发生时，触发相应的动作。</h1><p> select 的代码形式和 switch 非常相似， 不过 select 的 case 里的操作语句只能是”IO操作”（不仅仅是取值<code>&lt;-channel</code>，赋值<code>channel&lt;-</code>也可以）， select 会一直等待等到某个 case 语句完成，也就是等到成功从channel中读到数据。 则 select 语句结束</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    ch &lt;- <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> msg :=&lt;-ch:</span><br><span class="line">        fmt.Println(msg)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        fmt.Println(<span class="string">&quot;default&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">success</span><br></pre></td></tr></table></figure>

<p><code>default</code>可以判断chan是否已经满了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import &quot;fmt&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func main()&#123;</span><br><span class="line">    ch := make(chan int, 1)</span><br><span class="line"></span><br><span class="line">    select &#123;</span><br><span class="line">    case msg :=&lt;-ch:</span><br><span class="line">        fmt.Println(msg)</span><br><span class="line">    default:</span><br><span class="line">        fmt.Println(&quot;default&quot;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(&quot;success&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">default</span><br><span class="line">success</span><br></pre></td></tr></table></figure>
<p>此时因为<code>ch</code>中没有写入数据，为空，所以 case不会读取成功。 则 select 执行 default 语句。</p>
<h1 id="Go语言中不存在未初始化的变量"><a href="#Go语言中不存在未初始化的变量" class="headerlink" title="Go语言中不存在未初始化的变量"></a>Go语言中不存在未初始化的变量</h1><p>变量定义基本方式为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var 发量名字 类型 = 表达式</span><br></pre></td></tr></table></figure>
<p>其中类型和表达式均可省略，如果初始化表达式被省略，将用零值初始化该变量。</p>
<ul>
<li>数值变量对应的是0值</li>
<li>布尔变量对应的是false</li>
<li>字符串对应的零值是空字符串</li>
<li>接口或者引用类型（包括slice，map，chan）变量对应的是nil</li>
<li>数组或者结构体等聚合类型对应的零值是每个元素或字段对应该类型的零值。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s <span class="type">string</span> </span><br><span class="line">fmt.Println(s) <span class="comment">// &quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="注意的问题"><a href="#注意的问题" class="headerlink" title=":=注意的问题"></a><code>:=</code>注意的问题</h1><ul>
<li>使用<code>:=</code>定义的变量，仅能使用在函数内部。</li>
<li>在定义多个变量的时候<code>:=</code>周围不一定是全部都是刚刚声明的，有些可能只是赋值，例如下面的err变量 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">in, err := os.Open(infile)</span><br><span class="line"><span class="comment">// TODO</span></span><br><span class="line">out, err := os.Create(outfile)</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="new在Go语言中只是一个预定义的函数，它并不是一个关键字，我们可以将new作为变量或者其他"><a href="#new在Go语言中只是一个预定义的函数，它并不是一个关键字，我们可以将new作为变量或者其他" class="headerlink" title="new在Go语言中只是一个预定义的函数，它并不是一个关键字，我们可以将new作为变量或者其他"></a><code>new</code>在Go语言中只是一个预定义的函数，它并不是一个关键字，我们可以将<code>new</code>作为变量或者其他</h1><p>例如:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">delta</span><span class="params">(old, <span class="built_in">new</span> <span class="type">int</span>)</span></span> <span class="type">int</span> &#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">new</span> - old </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上是正确的。</p>
<h1 id="并不是使用new就一定会在堆上分配内存"><a href="#并不是使用new就一定会在堆上分配内存" class="headerlink" title="并不是使用new就一定会在堆上分配内存"></a>并不是使用<code>new</code>就一定会在堆上分配内存</h1><p>编译器会自动选择在栈上还是在堆上分配存储空间，但可能令人惊讶的是，这个选择并不是由用<code>var</code>还是<code>new</code>声明变量的方式决定的。</p>
<p>请看例子:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> global *<span class="type">int</span> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> x <span class="type">int</span> x=<span class="number">1</span> </span><br><span class="line">    global = &amp;x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">g</span><span class="params">()</span></span> &#123;</span><br><span class="line">    y := <span class="built_in">new</span>(<span class="type">int</span>)</span><br><span class="line">    *y = <span class="number">1</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>f()</code>函数中的<code>x</code>就是在堆上分配内存，而<code>g()</code>函数中的<code>y</code>就是分配在栈上。</p>
<h1 id="init函数在同一个文件中可以包含多个"><a href="#init函数在同一个文件中可以包含多个" class="headerlink" title="init函数在同一个文件中可以包含多个"></a><code>init</code>函数在同一个文件中可以包含多个</h1><p>在同一个包文件中，可以包含有多个<code>init</code>函数，多个<code>init</code>函数的执行顺序和定义顺序一致。</p>
<h1 id="Golang中没有“对象”"><a href="#Golang中没有“对象”" class="headerlink" title="Golang中没有“对象”"></a>Golang中没有“对象”</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> test <span class="keyword">struct</span> &#123;</span><br><span class="line">    name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *test)</span></span> getName()&#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> t *test</span><br><span class="line">    t = <span class="literal">nil</span></span><br><span class="line">    t.getName()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>能正常输出吗？会报错吗？</p>
<p>输出为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello world</span><br></pre></td></tr></table></figure>
<p>可以正常输出。Go本质上不是面向对象的语言，Go中是不存在object的含义的，Go语言书籍中的对象也和Java、PHP中的对象有区别，不是真正的”对象”，是Go中struct的实体。</p>
<p>调用getName方法，在Go中还可以转换，转换为：Type.method(t Type, arguments)<br>所以，以上代码main函数中还可以写成：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    (*test).getName(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Go中的指针-符号的含义"><a href="#Go中的指针-符号的含义" class="headerlink" title="Go中的指针*符号的含义"></a>Go中的指针<code>*</code>符号的含义</h1><p>&amp;的意思大家都明白的，取地址，假如你想获得一个变量的地址，只需在变量前加上&amp;即可。</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a := 1</span><br><span class="line">b := &amp;a</span><br></pre></td></tr></table></figure>
<p>现在，我拿到a的地址了，但是我想取得a指针指向的值，该如何操作呢？用<code>*</code>号，<code>*b</code>即可。<br>*的意思是对指针取值。</p>
<p>下面对a的值加一</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a := 1</span><br><span class="line">b := &amp;a</span><br><span class="line">*b++</span><br></pre></td></tr></table></figure>
<p><code>*</code>和<code>&amp;</code>可以相互抵消，同时注意，<code>*&amp;</code>可以抵消，但是<code>&amp;*</code>不可以；所以<code>a</code>和<code>*&amp;a</code>是一样的，和<code>*&amp;*&amp;*&amp;a</code>也是一样的。</p>
<h1 id="os-Args获取命令行指令参数，应该从数组的1坐标开始"><a href="#os-Args获取命令行指令参数，应该从数组的1坐标开始" class="headerlink" title="os.Args获取命令行指令参数，应该从数组的1坐标开始"></a><code>os.Args</code>获取命令行指令参数，应该从数组的1坐标开始</h1><p><code>os.Args</code>的第一个元素，<code>os.Args[0]</code>, 是命令本身的名字</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(os.Args[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码，经过<code>go build</code>之后，打包成一个可执行文件<code>main</code>，然后运行指令<code>./main 123</code></p>
<p>输出：<code>./main</code></p>
<h1 id="数组切片slice的容量问题带来的bug"><a href="#数组切片slice的容量问题带来的bug" class="headerlink" title="数组切片slice的容量问题带来的bug"></a>数组切片slice的容量问题带来的bug</h1><p>请看下列代码:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    array := [<span class="number">4</span>]<span class="type">int</span>&#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>&#125;</span><br><span class="line">    slice := array[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">    newSlice := <span class="built_in">append</span>(slice, <span class="number">50</span>)</span><br><span class="line">    newSlice[<span class="number">1</span>] += <span class="number">1</span></span><br><span class="line">    fmt.Println(slice)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请问输出什么?<br>答案是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[10 21]</span><br></pre></td></tr></table></figure>
<p>如果稍作修改，将以上newSlice改为扩容三次，newSlice :&#x3D; append(append(append(slice, 50), 100), 150)如下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    array := [<span class="number">4</span>]<span class="type">int</span>&#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>&#125;</span><br><span class="line">    slice := array[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">    newSlice := <span class="built_in">append</span>(<span class="built_in">append</span>(<span class="built_in">append</span>(slice, <span class="number">50</span>), <span class="number">100</span>), <span class="number">150</span>)</span><br><span class="line">    newSlice[<span class="number">1</span>] += <span class="number">1</span></span><br><span class="line">    fmt.Println(slice)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[10 20]</span><br></pre></td></tr></table></figure>

<p>这特么是什么鬼？<br>这就要从Golang切片的扩容说起了；切片的扩容，就是当切片添加元素时，切片容量不够了，就会扩容，扩容的大小遵循下面的原则：（如果切片的容量小于1024个元素，那么扩容的时候slice的cap就翻番，乘以2；一旦元素个数超过1024个元素，增长因子就变成1.25，即每次增加原来容量的四分之一。）如果扩容之后，还没有触及原数组的容量，那么，切片中的指针指向的位置，就还是原数组（这就是产生bug的原因）；如果扩容之后，超过了原数组的容量，那么，Go就会开辟一块新的内存，把原来的值拷贝过来，这种情况丝毫不会影响到原数组。<br>建议尽量避免bug的产生。</p>
<h1 id="map引用不存在的key，不报错"><a href="#map引用不存在的key，不报错" class="headerlink" title="map引用不存在的key，不报错"></a><code>map</code>引用不存在的key，不报错</h1><p>请问下面的例子输出什么，会报错吗？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    newMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>)</span><br><span class="line">    fmt.Println(newMap[<span class="string">&quot;a&quot;</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>答案是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0</span><br></pre></td></tr></table></figure>

<p>不报错。不同于PHP，Golang的map和Java的HashMap类似，Java引用不存在的会返回null，而Golang会返回初始值</p>
<h1 id="map使用range遍历顺序问题，并不是录入的顺序，而是随机顺序"><a href="#map使用range遍历顺序问题，并不是录入的顺序，而是随机顺序" class="headerlink" title="map使用range遍历顺序问题，并不是录入的顺序，而是随机顺序"></a>map使用range遍历顺序问题，并不是录入的顺序，而是随机顺序</h1><p>请看下面的例子:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    newMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">int</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++&#123;</span><br><span class="line">        newMap[i] = i</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> key, value := <span class="keyword">range</span> newMap&#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;key is %d, value is %d\n&quot;</span>, key, value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">key is 1, value is 1</span><br><span class="line">key is 3, value is 3</span><br><span class="line">key is 5, value is 5</span><br><span class="line">key is 7, value is 7</span><br><span class="line">key is 9, value is 9</span><br><span class="line">key is 0, value is 0</span><br><span class="line">key is 2, value is 2</span><br><span class="line">key is 4, value is 4</span><br><span class="line">key is 6, value is 6</span><br><span class="line">key is 8, value is 8</span><br></pre></td></tr></table></figure>

<p>是杂乱无章的顺序。map的遍历顺序不固定，这种设计是有意为之的，能为能防止程序依赖特定遍历顺序。</p>
<h1 id="channel作为函数参数传递，可以声明为只取"><a href="#channel作为函数参数传递，可以声明为只取" class="headerlink" title="channel作为函数参数传递，可以声明为只取(&lt;- chan)或者只发送(chan &lt;-)"></a>channel作为函数参数传递，可以声明为只取(&lt;- chan)或者只发送(chan &lt;-)</h1><p>一个函数在将channel作为一个类型的参数来声明的时候，可以将channl声明为只可以取值(&lt;- chan)或者只可以发送值(chan &lt;-)，不特殊说明，则既可以取值，也可以发送值。</p>
<p>例如：只可以发送值</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setData</span><span class="params">(ch <span class="keyword">chan</span> &lt;- <span class="type">string</span>)</span></span>&#123;</span><br><span class="line">    <span class="comment">//TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果在以上函数中存在&lt;-ch则会编译不通过。</p>
<p>如下是只可以取值:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setData</span><span class="params">(ch &lt;- <span class="keyword">chan</span>  <span class="type">string</span>)</span></span>&#123;</span><br><span class="line">    <span class="comment">//TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果以上函数中存在ch&lt;-则在编译期会报错</p>
<h1 id="使用channel时，注意goroutine之间的执行流程问题"><a href="#使用channel时，注意goroutine之间的执行流程问题" class="headerlink" title="使用channel时，注意goroutine之间的执行流程问题"></a>使用channel时，注意goroutine之间的执行流程问题</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line">    <span class="keyword">go</span> setData(ch)</span><br><span class="line">    fmt.Println(&lt;-ch)</span><br><span class="line">    fmt.Println(&lt;-ch)</span><br><span class="line">    fmt.Println(&lt;-ch)</span><br><span class="line">    fmt.Println(&lt;-ch)</span><br><span class="line">    fmt.Println(&lt;-ch)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setData</span><span class="params">(ch  <span class="keyword">chan</span>  <span class="type">string</span>)</span></span>&#123;</span><br><span class="line">    ch &lt;- <span class="string">&quot;test&quot;</span></span><br><span class="line">    ch &lt;- <span class="string">&quot;hello wolrd&quot;</span></span><br><span class="line">    ch &lt;- <span class="string">&quot;123&quot;</span></span><br><span class="line">    ch &lt;- <span class="string">&quot;456&quot;</span></span><br><span class="line">    ch &lt;- <span class="string">&quot;789&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上代码的执行流程是怎样的呢？<br>一个基于无缓存channel的发送或者取值操作，会导致当前goroutine阻塞，一直等待到另外的一个goroutine做相反的取值或者发送操作以后，才会正常跑。<br>以上例子中的流程是这样的：</p>
<p>主goroutine等待接收，另外的那一个goroutine发送了“test”并等待处理；完成通信后，打印出”test”；两个goroutine各自继续跑自己的。<br>主goroutine等待接收，另外的那一个goroutine发送了“hello world”并等待处理；完成通信后，打印出”hello world”；两个goroutine各自继续跑自己的。<br>主goroutine等待接收，另外的那一个goroutine发送了“123”并等待处理；完成通信后，打印出”123”；两个goroutine各自继续跑自己的。<br>主goroutine等待接收，另外的那一个goroutine发送了“456”并等待处理；完成通信后，打印出”456”；两个goroutine各自继续跑自己的。<br>主goroutine等待接收，另外的那一个goroutine发送了“789”并等待处理；完成通信后，打印出”789”；两个goroutine各自继续跑自己的。</p>
<p>记住：Golang的channel是用来goroutine之间通信的，且通信过程中会阻塞。</p>
<p><a href="https://i6448038.github.io/2017/10/06/GolangDetailsTwo/">Go语言的那些坑二</a><br><a href="https://i6448038.github.io/2018/07/18/golang-mistakes/">Go语言的那些坑三</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/28/GolangDetails/" data-id="clzo46bsy0002vajh7hfp2fot" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Phalcon的那些坑" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/09/Phalcon%E7%9A%84%E9%82%A3%E4%BA%9B%E5%9D%91/" class="article-date">
  <time datetime="2017-07-08T17:29:30.000Z" itemprop="datePublished">2017-07-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/09/Phalcon%E7%9A%84%E9%82%A3%E4%BA%9B%E5%9D%91/">Phalcon 的那些坑</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Phalcon-route路由只能访问根路径的问题"><a href="#Phalcon-route路由只能访问根路径的问题" class="headerlink" title="Phalcon route路由只能访问根路径的问题"></a>Phalcon route路由只能访问根路径的问题</h1><h2 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h2><p>   我用Phalcon-dev-tools创建了一个空的项目，然后比着文档一步一步往下做。刚开始还行，修改IndexController中的indexAction方法啥的都没有问题，可是，一旦自己写一个Controller或者在原有的Controller上添加其他<code>Action</code>方法，还是返回根路径<code>/</code>下的内容。<br>   这tm是咋回事儿？<br>   反复寻找答案，看文档的每一个细节，是否漏了某些代码？<br>   环境没问题吧？这都跑起来了，肯定是代码问题吧？</p>
<h2 id="问题原因以及解决"><a href="#问题原因以及解决" class="headerlink" title="问题原因以及解决"></a>问题原因以及解决</h2><p>   还真就是环境问题，不是php版本、Phalcon版本bug，是nginx配置问题！<br>   坑！<br>   Phalcon默认的URI信息是从<code>$_GET[&#39;_url&#39;]</code>获得，也可以设置为<code>$_SERER[&#39;REQUEST_URI&#39;]</code>获取。<br>   使用这两种不同方法获取，还得要不同的nginx配置！！（详情请看Phalcon文档 <a href="https://docs.phalconphp.com/zh/latest/reference/nginx.html#basic-configuration">Phalcon nginx配置</a>）<br>   这特么也得配置！<br>   使用<code>$_GET[&#39;_url&#39;]</code>（默认）：</p>
<pre><code>location / &#123;
        try_files $uri $uri/ /index.php?_url=$uri&amp;$args;
&#125;
</code></pre>
<p>   使用<code>$_SERVER[&#39;REQUEST_URI&#39;]</code>，nginx配置：</p>
<pre><code>location / &#123;
        try_files $uri $uri/ /index.php;
&#125;
</code></pre>
<p>   想要正常使用<code>$_SERVER[&#39;REQUEST_URI&#39;]</code>的方式，nginx配置完了还不要紧，还得在php代码里修改：</p>
<pre><code>use Phalcon\Mvc\Router;
$router-&gt;setUriSource(Router::URI_SOURCE_SERVER_REQUEST_URI);
</code></pre>
<h1 id="Phalcon3-1版本无法结合mongodb的问题"><a href="#Phalcon3-1版本无法结合mongodb的问题" class="headerlink" title="Phalcon3.1版本无法结合mongodb的问题"></a>Phalcon3.1版本无法结合mongodb的问题</h1><h2 id="问题现象-1"><a href="#问题现象-1" class="headerlink" title="问题现象"></a>问题现象</h2><p>   我在php5.6、Phalcon2.0的环境下按照如下方式把<code>mongodb</code>服务注入到Phalcon中是没问题的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$di</span>-&gt;<span class="title function_ invoke__">set</span>(</span><br><span class="line">  <span class="string">&quot;mongo&quot;</span>,</span><br><span class="line">  function () &#123;</span><br><span class="line">    <span class="variable">$mongo</span> = <span class="keyword">new</span> <span class="title class_">MongoClient</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$mongo</span>-&gt;<span class="title function_ invoke__">selectDB</span>(<span class="string">&quot;store&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="literal">true</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>  但是在php7.1、Phalcon3.1的环境下，却报错了。说找不到mongo类…</p>
<h2 id="问题原因以及解决-1"><a href="#问题原因以及解决-1" class="headerlink" title="问题原因以及解决"></a>问题原因以及解决</h2><p>左思右想，谷歌百度，刷新调试。原来，MongoClient这个类用到了php5.6的<code>mongo</code>这个扩展，PHP官方文档提示<code>mongo</code>扩展将由<code>mongodb</code>所替代，而<code>mongo</code>这个扩展在php7中已经不支持。php7中只支持<code>mongodb</code>这个扩展。<br>但是Phalcon3.1封装的类库MongoClient却引用了<code>mongo</code>这个库，所以报了错…</p>
<p>Phalcon研发组发现了这个问题，所以提供了一个php类库：<code>&quot;phalcon/incubator&quot;</code><br>只需要在composer包中加入此类库，用类库的类替代原来的类就可以了：</p>
<ul>
<li>在composer中加入（Phalcon2.x版本对应2.x版本，Phalcon3.x版本对应3.x版本）<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;phalcon/incubator&quot;: &quot;^3.1&quot;</span><br></pre></td></tr></table></figure></li>
<li>代码中引入<code>use Phalcon\Db\Adapter\MongoDB\Client</code>，然后代码中这样注入：<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$di</span>-&gt;<span class="title function_ invoke__">setShared</span>(<span class="string">&quot;mongo&quot;</span>, function()&#123;</span><br><span class="line">    <span class="variable">$mongoConfig</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getConfig</span>()-&gt;mongo;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> <span class="title class_">Client</span>(<span class="string">&quot;mongodb://<span class="subst">&#123;$mongoConfig-&gt;host&#125;</span>:<span class="subst">&#123;$mongoConfig-&gt;port&#125;</span>/?replicaSet=<span class="subst">&#123;$mongoConfig-&gt;replicaSet&#125;</span>&quot;</span>))</span><br><span class="line">        -&gt;<span class="title function_ invoke__">selectDatabase</span>(<span class="variable">$mongoConfig</span>-&gt;database);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li>如果想使用Phalcon中的<code>ODM</code>，原来是引用<code>use Phalcon\Mvc\Collection;</code>并继承。现在是引用以下：<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Phalcon</span>\<span class="title">Mvc</span>\<span class="title">MongoCollection</span>;</span><br></pre></td></tr></table></figure>
并继承它。</li>
</ul>
<h2 id="其他问题，出现-A-dependency-injector-container-is-required-to-obtain-the-services-related-to-the-ODM"><a href="#其他问题，出现-A-dependency-injector-container-is-required-to-obtain-the-services-related-to-the-ODM" class="headerlink" title="其他问题，出现 A dependency injector container is required to obtain the services related to the ODM"></a>其他问题，出现 <code>A dependency injector container is required to obtain the services related to the ODM</code></h2><p>这是由于加的包<code>&quot;phalcon/incubator&quot;: &quot;^3.1&quot;</code>对于PHP 7.1.0版本以上支持的不好，每次对实体保存的时候都会在mongo中保存一下一些脏数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;_dependencyInjector&quot; : &#123;&#125;,</span><br><span class="line">    &quot;_modelsManager&quot; : &#123;&#125;,</span><br><span class="line">    &quot;_source&quot; : null,</span><br><span class="line">    &quot;_operationMade&quot; : 1,</span><br><span class="line">    &quot;_dirtyState&quot; : 1,</span><br><span class="line">    &quot;_connection&quot; : &#123;&#125;,</span><br><span class="line">    &quot;_errorMessages&quot; : [],</span><br><span class="line">    &quot;_skipped&quot; : false,</span><br></pre></td></tr></table></figure>
<p>然后再次存数据的时候，就报错了。<br>解决办法就是重写<code>save()</code>方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">version_compare</span>(PHP_VERSION, <span class="string">&#x27;7.1.0&#x27;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_dependencyInjector = <span class="title class_">\Phalcon\Di</span>::<span class="title function_ invoke__">getDefault</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_modelsManager = <span class="variable language_">$this</span>-&gt;_dependencyInjector-&gt;<span class="title function_ invoke__">getShared</span>(<span class="string">&quot;collectionManager&quot;</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_modelsManager-&gt;<span class="title function_ invoke__">initialize</span>(<span class="variable">$this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">parent</span>::<span class="title function_ invoke__">save</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="Phalcon无法使用redis或者memcached作为Phalcon的缓存服务"><a href="#Phalcon无法使用redis或者memcached作为Phalcon的缓存服务" class="headerlink" title="Phalcon无法使用redis或者memcached作为Phalcon的缓存服务"></a>Phalcon无法使用<code>redis</code>或者<code>memcached</code>作为Phalcon的缓存服务</h1><h2 id="问题现象-2"><a href="#问题现象-2" class="headerlink" title="问题现象"></a>问题现象</h2><p>使用Phalcon封装好的缓存类，只需要如下操作就可以了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Phalcon</span>\<span class="title">Cache</span>\<span class="title">Frontend</span>\<span class="title">Data</span> <span class="keyword">as</span> <span class="title">FrontData</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Phalcon</span>\<span class="title">Cache</span>\<span class="title">Backend</span>\<span class="title">Redis</span> <span class="keyword">as</span> <span class="title">BackendData</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$di</span>-&gt;<span class="title function_ invoke__">setShared</span>(<span class="string">&#x27;redis&#x27;</span>, function()&#123;</span><br><span class="line">    <span class="variable">$config</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getConfig</span>();</span><br><span class="line">    <span class="variable">$redisConfig</span> = <span class="variable">$config</span>-&gt;sess_redis;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$frontend</span> = <span class="keyword">new</span> <span class="title class_">FrontData</span>([<span class="string">&#x27;lifetime&#x27;</span> =&gt; <span class="variable">$config</span>-&gt;cache-&gt;lifetime]);</span><br><span class="line">    <span class="variable">$cache</span> = <span class="keyword">new</span> <span class="title class_">BackendRedis</span>(<span class="variable">$frontend</span>, </span><br><span class="line">        [</span><br><span class="line">            <span class="string">&quot;host&quot;</span> =&gt; <span class="variable">$redisConfig</span>-&gt;host,</span><br><span class="line">            <span class="string">&quot;port&quot;</span> =&gt; <span class="variable">$redisConfig</span>-&gt;port,</span><br><span class="line">            <span class="string">&quot;persistent&quot;</span> =&gt; <span class="variable">$redisConfig</span>-&gt;pconnect</span><br><span class="line">        ]</span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$cache</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>但是有时候报错，找不到redis类…</p>
<h2 id="问题原因以及解决-2"><a href="#问题原因以及解决-2" class="headerlink" title="问题原因以及解决"></a>问题原因以及解决</h2><p>这是因为Phalcon扩展在封装缓存类的时候，引用了PHP的<code>redis</code>扩展，而<code>redis</code>扩展并不是php的标准扩展包，so…<br>只需要安装好<code>redis</code>扩展就好。<br>同理，假如报<code>memcache</code>找不到，只需要安装相应扩展就好。</p>
<h1 id="Phalcon-ORM使用Join语句出现The-column-XXX-is-ambiguous或者-Model-XXX-could-not-be-loaded的问题"><a href="#Phalcon-ORM使用Join语句出现The-column-XXX-is-ambiguous或者-Model-XXX-could-not-be-loaded的问题" class="headerlink" title="Phalcon ORM使用Join语句出现The column &#39;XXX&#39; is ambiguous或者 Model &#39;XXX&#39; could not be loaded的问题"></a>Phalcon ORM使用<code>Join</code>语句出现<code>The column &#39;XXX&#39; is ambiguous</code>或者 <code>Model &#39;XXX&#39; could not be loaded</code>的问题</h1><h2 id="问题现象以及解决"><a href="#问题现象以及解决" class="headerlink" title="问题现象以及解决"></a>问题现象以及解决</h2><p>在使用Phalcon的ORM进行<code>Join</code>语句的时候，需要如下操作</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$infos</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">query</span>()-&gt;<span class="title function_ invoke__">inWhere</span>(<span class="string">&quot;tkey&quot;</span>, <span class="variable">$uids</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">leftJoin</span>(<span class="string">&quot;RealData&quot;</span>, <span class="string">&quot;User.tkey=RealData.tkey&quot;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">leftJoin</span>(<span class="string">&quot;UserFace&quot;</span>, <span class="string">&quot;User.tkey=UserFace.tkey&quot;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">columns</span>([</span><br><span class="line">                <span class="string">&quot;RealData.company&quot;</span>,</span><br><span class="line">                <span class="string">&quot;RealData.status&quot;</span>,</span><br><span class="line">                <span class="string">&quot;RealData.post&quot;</span>,</span><br><span class="line">                <span class="string">&quot;RealData.area&quot;</span>,</span><br><span class="line">                <span class="string">&quot;User.name&quot;</span>,</span><br><span class="line">                <span class="string">&quot;User.flag&quot;</span>,</span><br><span class="line">                <span class="string">&quot;User.sex&quot;</span>,</span><br><span class="line">                <span class="string">&quot;User.tkey&quot;</span>,</span><br><span class="line">                <span class="string">&quot;User.sequence&quot;</span>,</span><br><span class="line">                <span class="string">&quot;User.mobile&quot;</span>,</span><br><span class="line">                <span class="string">&quot;User.othermobile&quot;</span>,</span><br><span class="line">                <span class="string">&quot;User.integrity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;UserFace.filename&quot;</span></span><br><span class="line">            ])</span><br><span class="line">            -&gt;<span class="title function_ invoke__">execute</span>();</span><br></pre></td></tr></table></figure>
<p>报 <code>Model &#39;XXX&#39; could not be loaded</code>的错误，看看<code>leftJoin</code>方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Adds a LEFT join to the query</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;</span></span><br><span class="line"><span class="comment">     * $criteria-&gt;leftJoin(&quot;Robots&quot;, &quot;r.id = RobotsParts.robots_id&quot;, &quot;r&quot;);</span></span><br><span class="line"><span class="comment">     * &lt;/code&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $model</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mixed $conditions</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mixed $alias</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Criteria</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leftJoin</span>(<span class="params"><span class="variable">$model</span>, <span class="variable">$conditions</span> = <span class="literal">null</span>, <span class="variable">$alias</span> = <span class="literal">null</span></span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>感觉没毛病，细细想来，发现<code>Model</code>参数应该是该写的是<code>namespace</code>吧，于是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="variable language_">class</span>;</span><br><span class="line">        <span class="variable">$realdata</span> = <span class="title class_">RealData</span>::<span class="variable language_">class</span>;</span><br><span class="line">        <span class="variable">$userface</span> = <span class="title class_">UserFace</span>::<span class="variable language_">class</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$infos</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">query</span>()-&gt;<span class="title function_ invoke__">inWhere</span>(<span class="string">&quot;tkey&quot;</span>, <span class="variable">$uids</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">leftJoin</span>(<span class="variable">$realdata</span>, <span class="string">&quot;<span class="subst">$user</span>.tkey=<span class="subst">$realdata</span>.tkey&quot;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">leftJoin</span>(<span class="variable">$userface</span>, <span class="string">&quot;<span class="subst">$user</span>.tkey=<span class="subst">$userface</span>.tkey&quot;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">columns</span>([</span><br><span class="line">                <span class="string">&quot;<span class="subst">$realdata</span>.company&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$realdata</span>.status&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$realdata</span>.post&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$realdata</span>.area&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$user</span>.name&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$user</span>.flag&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$user</span>.sex&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$user</span>.tkey&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$user</span>.sequence&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$user</span>.mobile&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$user</span>.othermobile&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$user</span>.integrity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$userface</span>.filename&quot;</span></span><br><span class="line">            ])</span><br><span class="line">            -&gt;<span class="title function_ invoke__">execute</span>();</span><br></pre></td></tr></table></figure>
<p>但是又出现了新问题：<code>The column &#39;tkey&#39; is ambiguous, </code>，将SQL解析后发现：SQL语句中是不允许先”where 然后 join”的，但是Phalcon帮我们封装的时候，帮我们避开了这个问题：where 语句可以在Join之前写，但是最终解析的sql还是在join之后，既然在join之后，那么<code>tkey</code>当然就不明确咯,改成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="variable language_">class</span>;</span><br><span class="line"><span class="variable">$realdata</span> = <span class="title class_">RealData</span>::<span class="variable language_">class</span>;</span><br><span class="line"><span class="variable">$userface</span> = <span class="title class_">UserFace</span>::<span class="variable language_">class</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$infos</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">query</span>()-&gt;<span class="title function_ invoke__">inWhere</span>(<span class="string">&quot;<span class="subst">$user</span>.tkey&quot;</span>, <span class="variable">$uids</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">leftJoin</span>(<span class="variable">$realdata</span>, <span class="string">&quot;<span class="subst">$user</span>.tkey=<span class="subst">$realdata</span>.tkey&quot;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">leftJoin</span>(<span class="variable">$userface</span>, <span class="string">&quot;<span class="subst">$user</span>.tkey=<span class="subst">$userface</span>.tkey&quot;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">columns</span>([</span><br><span class="line">                <span class="string">&quot;<span class="subst">$realdata</span>.company&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$realdata</span>.status&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$realdata</span>.post&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$realdata</span>.area&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$user</span>.name&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$user</span>.flag&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$user</span>.sex&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$user</span>.tkey&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$user</span>.sequence&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$user</span>.mobile&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$user</span>.othermobile&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$user</span>.integrity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="subst">$userface</span>.filename&quot;</span></span><br><span class="line">            ])</span><br><span class="line">            -&gt;<span class="title function_ invoke__">execute</span>();</span><br></pre></td></tr></table></figure>
<p>问题就解决了</p>
<h1 id="Phalcon-设置model之间的Realaction-通过一个model的实体找不到另一实体"><a href="#Phalcon-设置model之间的Realaction-通过一个model的实体找不到另一实体" class="headerlink" title="Phalcon 设置model之间的Realaction 通过一个model的实体找不到另一实体"></a>Phalcon 设置model之间的Realaction 通过一个model的实体找不到另一实体</h1><p>model之间的对应关系，通常是在model的<code>initialize</code>方法中实现，但是在实现的时候，要特别注意：Phalcon中参数都为定义的Model类，而不是MySQL中的table名字，这就带来一个问题：类名必须加namespace，生成的model的property名字奇怪或者引用不了。解决方法就是加上一个别名<code>alias</code>，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasMany</span>(<span class="string">&quot;order_no&quot;</span>, <span class="title class_">OrderDetail</span>::<span class="variable language_">class</span>, <span class="string">&quot;order_no&quot;</span>, </span><br><span class="line">[<span class="string">&quot;alias&quot;</span> =&gt; <span class="string">&#x27;orderDetail&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<h1 id="Phalcon-请求处理中getPost-“”-找不到数据和处理json数据的问题"><a href="#Phalcon-请求处理中getPost-“”-找不到数据和处理json数据的问题" class="headerlink" title="Phalcon 请求处理中getPost(“”)找不到数据和处理json数据的问题"></a>Phalcon 请求处理中getPost(“”)找不到数据和处理json数据的问题</h1><p>在Phalcon中，发送post请求的时候，如果post请求中的<code>Content-Type</code>是以<code>application/json</code> 的json形式发送请求数据，那么，使用<code>$this-&gt;request-&gt;getPost(&quot;xxx&quot;)</code>是拿不到任何数据的，必须使用<code>$this-&gt;request-&gt;getJsonRawBody()</code>这个方法。</p>
<ul>
<li>$this-&gt;request-&gt;getJsonRawBody(true) 拿到的是一个请求数组</li>
<li>$this-&gt;request-&gt;getJsonRawBody() 拿到的是一个object</li>
</ul>
<h1 id="Phalcon-中使用where查询"><a href="#Phalcon-中使用where查询" class="headerlink" title="Phalcon 中使用where查询"></a>Phalcon 中使用where查询</h1><h2 id="连续几个where条件，不能和laravel等其他框架一样，好几个where并排，只能有一个-where，剩下的都是andWhere"><a href="#连续几个where条件，不能和laravel等其他框架一样，好几个where并排，只能有一个-where，剩下的都是andWhere" class="headerlink" title="连续几个where条件，不能和laravel等其他框架一样，好几个where并排，只能有一个 where，剩下的都是andWhere"></a>连续几个where条件，不能和laravel等其他框架一样，好几个where并排，只能有一个 <code>where</code>，剩下的都是<code>andWhere</code></h2><p>可能习惯了其他框架（例如：laravel 的查询，喜欢连续的<code>where</code>），如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$members</span> = <span class="title class_">Member</span>::<span class="title function_ invoke__">query</span>()</span><br><span class="line">           -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id = :uid:&quot;</span>)</span><br><span class="line">           -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;member_id = :memberId:&quot;</span>)</span><br><span class="line">           -&gt;<span class="title function_ invoke__">bind</span>([</span><br><span class="line">               <span class="string">&quot;uid&quot;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">               <span class="string">&quot;memberId&quot;</span> =&gt; <span class="number">1</span></span><br><span class="line">           ])</span><br><span class="line">           -&gt;<span class="title function_ invoke__">execute</span>();</span><br></pre></td></tr></table></figure>

<p>感觉没毛病，但是一运行就报错：<code>SQLSTATE[HY093]: Invalid parameter number: number of bound variables does not match number of tokens</code>，通过打印出来（语句为<code>$this-&gt;di-&gt;get(&#39;profiler&#39;)-&gt;getLastProfile()-&gt;getSQLStatement()</code>）的SQL可以看出来，上条语句转义的SQL语句中连续写了两个<code>where</code>，并不是 <code>where ... AND ...</code>这就和预期不太一致。改为如下代码，就正常了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$members</span> = <span class="title class_">Member</span>::<span class="title function_ invoke__">query</span>()</span><br><span class="line">            -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id = :uid:&quot;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">andWhere</span>(<span class="string">&quot;member_id = :memberId:&quot;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">bind</span>([</span><br><span class="line">                <span class="string">&quot;uid&quot;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;memberId&quot;</span> =&gt; <span class="number">1</span></span><br><span class="line">            ])</span><br><span class="line">            -&gt;<span class="title function_ invoke__">execute</span>();</span><br></pre></td></tr></table></figure>

<h2 id="有inWhere的情况下，bind要写在where或者andWhere语句之后，不能和inWhere掺和在一起"><a href="#有inWhere的情况下，bind要写在where或者andWhere语句之后，不能和inWhere掺和在一起" class="headerlink" title="有inWhere的情况下，bind要写在where或者andWhere语句之后，不能和inWhere掺和在一起"></a>有<code>inWhere</code>的情况下，<code>bind</code>要写在<code>where</code>或者<code>andWhere</code>语句之后，不能和<code>inWhere</code>掺和在一起</h2><p>如下语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$members</span> = <span class="title class_">Member</span>::<span class="title function_ invoke__">query</span>()</span><br><span class="line">            -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id = :uid:&quot;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">andWhere</span>(<span class="string">&quot;member_id = :memberId:&quot;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">inWhere</span>(<span class="string">&quot;country&quot;</span>, [<span class="number">86</span>])</span><br><span class="line">            -&gt;<span class="title function_ invoke__">bind</span>([</span><br><span class="line">                <span class="string">&quot;uid&quot;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;memberId&quot;</span> =&gt; <span class="number">1</span></span><br><span class="line">            ])</span><br><span class="line">            -&gt;<span class="title function_ invoke__">execute</span>();</span><br></pre></td></tr></table></figure>
<p> 运行后报错：<br> <code>SQLSTATE[HY093]: Invalid parameter number: number of bound variables does not match number of tokens</code><br> 原因是：<code>bind</code>没有和连续的where语句“绑”在一起。</p>
<p> 应该写成：<br> <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$members</span> = <span class="title class_">Member</span>::<span class="title function_ invoke__">query</span>()</span><br><span class="line">           -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id = :uid:&quot;</span>)</span><br><span class="line">           -&gt;<span class="title function_ invoke__">andWhere</span>(<span class="string">&quot;member_id = :memberId:&quot;</span>)</span><br><span class="line">           -&gt;<span class="title function_ invoke__">bind</span>([</span><br><span class="line">               <span class="string">&quot;uid&quot;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">               <span class="string">&quot;memberId&quot;</span> =&gt; <span class="number">1</span></span><br><span class="line">           ])</span><br><span class="line">           -&gt;<span class="title function_ invoke__">inWhere</span>(<span class="string">&quot;country&quot;</span>, [<span class="number">86</span>])</span><br><span class="line">           -&gt;<span class="title function_ invoke__">execute</span>();</span><br></pre></td></tr></table></figure></p>
<h1 id="where语句中有时间的比较的时候，时间单位若为Y-m-d-H-i-s格式，一定要把在时间上加上引号"><a href="#where语句中有时间的比较的时候，时间单位若为Y-m-d-H-i-s格式，一定要把在时间上加上引号" class="headerlink" title="where语句中有时间的比较的时候，时间单位若为Y-m-d H:i:s格式，一定要把在时间上加上引号"></a>where语句中有时间的比较的时候，时间单位若为<code>Y-m-d H:i:s</code>格式，一定要把在时间上加上引号</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$orderPayment</span> = <span class="title class_">OrderPayment</span>::<span class="title function_ invoke__">query</span>()</span><br><span class="line">           -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;order_no = :orderNo:&quot;</span>)</span><br><span class="line">           -&gt;<span class="title function_ invoke__">andWhere</span>(<span class="string">&quot;add_time &gt;= 2017-07-08 15:51:53&quot;</span>)</span><br><span class="line">           -&gt;<span class="title function_ invoke__">bind</span>([<span class="string">&quot;orderNo&quot;</span> =&gt; <span class="number">1707080031</span>])</span><br><span class="line">           -&gt;<span class="title function_ invoke__">execute</span>();</span><br></pre></td></tr></table></figure>
<p>以上代码报错：<code>Syntax error, unexpected token INTEGER(15), near to &#39;:51:53)&#39;</code></p>
<p>因为<code>Y-m-d H:i:s</code>格式的时间，中间有个空格，导致Phalcon无法正确的解析加上引号就好了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$orderPayment</span> = <span class="title class_">OrderPayment</span>::<span class="title function_ invoke__">query</span>()</span><br><span class="line">           -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;order_no = :orderNo:&quot;</span>)</span><br><span class="line">           -&gt;<span class="title function_ invoke__">andWhere</span>(<span class="string">&quot;add_time &gt;= &#x27;2017-07-08 15:51:53&#x27;&quot;</span>)</span><br><span class="line">           -&gt;<span class="title function_ invoke__">bind</span>([<span class="string">&quot;orderNo&quot;</span> =&gt; <span class="number">1707080031</span>])</span><br><span class="line">           -&gt;<span class="title function_ invoke__">execute</span>();</span><br></pre></td></tr></table></figure>

<h1 id="Phalcon-update更新语句问题"><a href="#Phalcon-update更新语句问题" class="headerlink" title="Phalcon update更新语句问题"></a>Phalcon update更新语句问题</h1><p>Phalcon一般的update方式为：先查询，拿到实体<code>model</code>;然后实体<code>model</code>的字段赋值<code>$model-&gt;xxxx = xxxx</code>,最后运行<code>$model-&gt;update()</code>，并判断<code>update</code>方法的返回值是true还是false，来判断更新是否成功。<br>但是，在高并发条件下，最好是<code>update table set columnA = xxx where colum = AND ...</code>这种形式。<br>代码为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//项目启动的时候先注入</span></span><br><span class="line"><span class="variable">$di</span>-&gt;<span class="title function_ invoke__">set</span>(<span class="string">&#x27;modelsManager&#x27;</span>, function() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ModelsManager</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">//业务代码中</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;update <span class="subst">$model</span>  set wallet_money = <span class="subst">$remainMoney</span> </span></span><br><span class="line"><span class="string">where id = <span class="subst">&#123;$requestList[&#x27;uid&#x27;]&#125;</span> </span></span><br><span class="line"><span class="string">AND wallet_money = <span class="subst">&#123;$user-&gt;wallet_money&#125;</span>&quot;</span>;</span><br><span class="line">        </span><br><span class="line"><span class="variable">$manager</span> = <span class="variable language_">$this</span>-&gt;modelsManager-&gt;<span class="title function_ invoke__">executeQuery</span>(<span class="variable">$sql</span>);</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$manager</span>-&gt;<span class="title function_ invoke__">success</span>() == <span class="literal">false</span>)<span class="comment">//插入失败</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//todo</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可是这却存在一个问题：<br>假如说<code>where</code>语句得到的是一个空行，不存在的数据，那么以上语句执行之后，还是会返回true。<br>也就是说其实Phalcon仅仅是判断的是否SQL返回正确，并没有判断改变了多少行，所以在用的时候要特别小心。尽量加上redis制作一个分布式锁。</p>
<h1 id="Phalcon-model-查询方法find-和findFirst-的使用"><a href="#Phalcon-model-查询方法find-和findFirst-的使用" class="headerlink" title="Phalcon model 查询方法find()和findFirst()的使用"></a>Phalcon model 查询方法<code>find()</code>和<code>findFirst()</code>的使用</h1><h2 id="find的使用"><a href="#find的使用" class="headerlink" title="find的使用"></a><code>find</code>的使用</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$member</span> = <span class="title class_">Member</span>::<span class="title function_ invoke__">find</span>(</span><br><span class="line">           [</span><br><span class="line">               <span class="string">&quot;conditions&quot;</span> =&gt; <span class="string">&quot;mobile = 15166266859 AND country = 86 AND role_id = 2&quot;</span>,</span><br><span class="line"></span><br><span class="line">           ]</span><br><span class="line">       );</span><br></pre></td></tr></table></figure>
<p>或者：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$member</span> = <span class="title class_">Member</span>::<span class="title function_ invoke__">find</span>(</span><br><span class="line">            [</span><br><span class="line">                <span class="string">&quot;conditions&quot;</span> =&gt; <span class="string">&quot;mobile = ?1 AND country = ?2 AND role_id = ?3&quot;</span>,</span><br><span class="line">                <span class="string">&quot;bind&quot;</span> =&gt; [</span><br><span class="line">                    <span class="number">1</span> =&gt; <span class="string">&quot;15166266859&quot;</span>,</span><br><span class="line">                    <span class="number">2</span> =&gt; <span class="number">86</span>,</span><br><span class="line">                    <span class="number">3</span> =&gt; <span class="number">2</span></span><br><span class="line">                ]</span><br><span class="line"></span><br><span class="line">            ]</span><br><span class="line">        );</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$member</span> = <span class="title class_">Member</span>::<span class="title function_ invoke__">find</span>(</span><br><span class="line">           [</span><br><span class="line">               <span class="string">&quot;conditions&quot;</span> =&gt; <span class="string">&quot;mobile = :mobile: AND country = :country: AND role_id = :role:&quot;</span>,</span><br><span class="line">               <span class="string">&quot;bind&quot;</span> =&gt; [</span><br><span class="line">                   <span class="string">&quot;mobile&quot;</span> =&gt; <span class="string">&quot;15166266859&quot;</span>,</span><br><span class="line">                   <span class="string">&quot;country&quot;</span> =&gt; <span class="number">86</span>,</span><br><span class="line">                   <span class="string">&quot;role&quot;</span> =&gt; <span class="number">2</span></span><br><span class="line">               ]</span><br><span class="line"></span><br><span class="line">           ]</span><br><span class="line">       );</span><br></pre></td></tr></table></figure>

<h2 id="findFirst-的使用"><a href="#findFirst-的使用" class="headerlink" title="findFirst()的使用"></a><code>findFirst()</code>的使用</h2><p><code>find()</code>能使用的，<code>findFirst()</code>都可以使用，而且，<code>findFirst()</code>还多了一种：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$member</span> = <span class="title class_">Member</span>::<span class="title function_ invoke__">findFirst</span>(<span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<h2 id="特别注意：Phalcon中ODM和ORM对find及findFirst的操作是不相同的"><a href="#特别注意：Phalcon中ODM和ORM对find及findFirst的操作是不相同的" class="headerlink" title="特别注意：Phalcon中ODM和ORM对find及findFirst的操作是不相同的"></a>特别注意：Phalcon中<code>ODM</code>和<code>ORM</code>对<code>find</code>及<code>findFirst</code>的操作是不相同的</h2><p>ODM中可以这么用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$action</span> = <span class="title class_">UserAction</span>::<span class="title function_ invoke__">findFirst</span>(</span><br><span class="line">           [</span><br><span class="line">               <span class="string">&quot;conditions&quot;</span> =&gt; [</span><br><span class="line">                   <span class="string">&quot;share_info.promo_code&quot;</span> =&gt; <span class="string">&quot;promo_code_1&quot;</span></span><br><span class="line">               ]</span><br><span class="line">           ]</span><br><span class="line">       );</span><br><span class="line"><span class="comment">//   conditions 是一个数组，包含查询条件，但是，ORM不可以这么用！     </span></span><br></pre></td></tr></table></figure>
<p><code>conditions</code> 是一个数组，包含查询条件，但是，ORM不可以这么用！我想，可能是因为SQL语句中不仅包含<code>AND</code>还包含<code>OR</code>，直接用数组的话… (<em>^__^</em>) </p>
<p>ODM中还可以直接这么用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$action = UserAction::findFirst(</span><br><span class="line">            [</span><br><span class="line">                [</span><br><span class="line">                    &quot;share_info.promo_code&quot; =&gt; &quot;promo_code_1&quot;</span><br><span class="line">                ]</span><br><span class="line">            ]</span><br><span class="line">        );</span><br></pre></td></tr></table></figure>

<h1 id="Mac本地环境下不缺少类，但是一发布到测试环境，就报错xx-class-cannot-be-loaded"><a href="#Mac本地环境下不缺少类，但是一发布到测试环境，就报错xx-class-cannot-be-loaded" class="headerlink" title="Mac本地环境下不缺少类，但是一发布到测试环境，就报错xx class cannot be loaded"></a>Mac本地环境下不缺少类，但是一发布到测试环境，就报错<code>xx class cannot be loaded</code></h1><p>可能存在这样的原因：<br>你的包名为小写，而你的包下的<code>namespace</code>为大写，而你在引用了包的时候，仅仅引入了某个父包的namespace，而没有引入父包下每个子包的包名，在Mac下，不区分大小写，可以正常跑，但是到了Linux环境中，区分大小写，系统只会通过<code>namespace</code>的大写来找目录，而包名又都是小写，因而会找不到~<br>所以，应该避免如下简写：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$loader</span> = <span class="keyword">new</span> <span class="title class_">\Phalcon\Loader</span>();</span><br><span class="line"><span class="variable">$loader</span>-&gt;<span class="title function_ invoke__">registerNamespaces</span>([</span><br><span class="line">    <span class="string">&#x27;API&#x27;</span>       =&gt; BASE_PATH . <span class="string">&#x27;/apps/api/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Common&#x27;</span>    =&gt; BASE_PATH . <span class="string">&#x27;/apps/common/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;JiYu&#x27;</span>      =&gt; BASE_PATH . <span class="string">&#x27;/apps/jiyu/&#x27;</span>,</span><br><span class="line">])-&gt;<span class="title function_ invoke__">register</span>();</span><br></pre></td></tr></table></figure>
<p>而是将各个父目录下的子目录都给它引上</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$loader</span> = <span class="keyword">new</span> <span class="title class_">\Phalcon\Loader</span>();</span><br><span class="line"><span class="variable">$loader</span>-&gt;<span class="title function_ invoke__">registerNamespaces</span>([</span><br><span class="line">    <span class="string">&#x27;API&#x27;</span>       =&gt; BASE_PATH . <span class="string">&#x27;/apps/api/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Common&#x27;</span>    =&gt; BASE_PATH . <span class="string">&#x27;/apps/common/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;JiYu&#x27;</span>      =&gt; BASE_PATH . <span class="string">&#x27;/apps/jiyu/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;JiYu\Model&#x27;</span>      =&gt; BASE_PATH . <span class="string">&#x27;/apps/jiyu/model/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;API\Controller&#x27;</span>       =&gt; BASE_PATH . <span class="string">&#x27;/apps/api/controller/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Common\Model&#x27;</span> =&gt; BASE_PATH . <span class="string">&#x27;/apps/common/model/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Common\Validator&#x27;</span> =&gt; BASE_PATH . <span class="string">&#x27;/apps/common/validator/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Common\Observer&#x27;</span> =&gt; BASE_PATH . <span class="string">&#x27;/apps/common/observer/&#x27;</span>,</span><br><span class="line"></span><br><span class="line">])-&gt;<span class="title function_ invoke__">register</span>();</span><br></pre></td></tr></table></figure>

<h1 id="cli程序必须跑到指定的目录下"><a href="#cli程序必须跑到指定的目录下" class="headerlink" title="cli程序必须跑到指定的目录下"></a>cli程序必须跑到指定的目录下</h1><p>假如你想使用phalcon的 task功能，然后使用<code>crontab</code>来作定时脚本任务，会经常出现“路径找不到的问题”…</p>
<p>细究其原因，是因为 <code>run</code>文件中的诸多文件都是以 <code>run</code>文件所在的位置作为“中心”来查找其他文件的，假如运行的当前目录中没有 <code>run</code>文件，那么就会报找不到某某某文件的错误。解决这个问题的途径也很简单，只需要让当前目录移动到<code>run</code>文件所在的目录就好了。</p>
<h1 id="哪怕使用PHQL-，重写-model的update方法也会有问题"><a href="#哪怕使用PHQL-，重写-model的update方法也会有问题" class="headerlink" title="哪怕使用PHQL ，重写 model的update方法也会有问题"></a>哪怕使用PHQL ，重写 model的update方法也会有问题</h1><p>假如你重写了<code>model</code>的<code>update</code>方法，而你又想用偏原生SQL的方式去避开<code>model</code>的<code>update</code>方法带来的修改，例如你选择Phalcon自带的PHQL来躲避update方法的修改。那么，你就大错特错了，使用PHQL最终会调用<code>excute</code>方法，实际上就是拼出了model name，然后find相关的model；之后的操作，都是针对model的，也就是说，最终还会调用你重写的model的<code>update</code>方法…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/09/Phalcon%E7%9A%84%E9%82%A3%E4%BA%9B%E5%9D%91/" data-id="clzo46bta000kvajhaz9f5z8g" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/" rel="tag">php</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-rest-接口规范" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/28/rest-%E6%8E%A5%E5%8F%A3%E8%A7%84%E8%8C%83/" class="article-date">
  <time datetime="2017-06-27T16:49:08.000Z" itemprop="datePublished">2017-06-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/28/rest-%E6%8E%A5%E5%8F%A3%E8%A7%84%E8%8C%83/">RESTful API规范（详细版）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><code>rest</code>是一种软件架构风格，如果你们的接口是<code>rest</code>接口，那么就可被认为你们的的接口是restful的，英文名词和形容词的区别。</p>
<p><code>rest</code>接口是围绕“资源”展开的，利用HTTP的协议，其实rest本也可以和HTTP无关，但是现在大家普遍的使用<code>rest</code>都是依托于HTTP协议。HTTP 的url即资源。</p>
<p><code>RFC 3986</code>定义了通用的URI语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">URI = scheme “://” authority “/” path [ “?” query ][ “#” fragment ]</span><br></pre></td></tr></table></figure>

<ul>
<li>scheme: 指底层用的协议，如http、https、ftp</li>
<li>host: 服务器的IP地址或者域名</li>
<li>port: 端口，http中默认80</li>
<li>path: 访问资源的路径，就是咱们各种web 框架中定义的route路由</li>
<li>query: 为发送给服务器的参数</li>
<li>fragment: 锚点，定位到页面的资源，锚点为资源id</li>
</ul>
<h1 id="RESTful-API设计"><a href="#RESTful-API设计" class="headerlink" title="RESTful API设计"></a>RESTful API设计</h1><h3 id="资源路径"><a href="#资源路径" class="headerlink" title="资源路径"></a>资源路径</h3><p>对于rest资源的定义，即URL的定义，是最重要的；想要设计出优雅的、易读的rest 接口，其实还是听不容易的。</p>
<h3 id="URL中不能有动词"><a href="#URL中不能有动词" class="headerlink" title="URL中不能有动词"></a>URL中不能有动词</h3><p>在Restful架构中，每个网址代表的是一种资源，所以网址中不能有动词，只能有名词，动词由HTTP的 get、post、put、delete 四种方法来表示。</p>
<h3 id="URL结尾不应该包含斜杠“-”"><a href="#URL结尾不应该包含斜杠“-”" class="headerlink" title="URL结尾不应该包含斜杠“&#x2F;”"></a>URL结尾不应该包含斜杠“&#x2F;”</h3><p>这是作为URL路径中处理中最重要的规则之一，正斜杠（&#x2F;）不会增加语义值，且可能导致混淆。REST API不允许一个尾部的斜杠，不应该将它们包含在提供给客户端的链接的结尾处。<br>许多Web组件和框架将平等对待以下两个URI：<br><a href="http://api.canvas.com/shapes/">http://api.canvas.com/shapes/</a><br><a href="http://api.canvas.com/shapes">http://api.canvas.com/shapes</a></p>
<p>但是，实际上URI中的每个字符都会计入资源的唯一身份的识别中。</p>
<p>两个不同的URI映射到两个不同的资源。如果URI不同，那么资源也是如此，反之亦然。因此，REST API必须生成和传递精确的URI，不能容忍任何的客户端尝试不精确的资源定位。</p>
<p>有些API碰到这种情况，可能设计为让客户端重定向到相应没有尾斜杠的URI（也有可能会返回301 - 用来资源重定向）。</p>
<h3 id="正斜杠分隔符”-“必须用来指示层级关系"><a href="#正斜杠分隔符”-“必须用来指示层级关系" class="headerlink" title="正斜杠分隔符”&#x2F;“必须用来指示层级关系"></a>正斜杠分隔符”&#x2F;“必须用来指示层级关系</h3><p>rul的路径中的正斜杠“&#x2F;“字符用于指示资源之间的层次关系。<br>例如：<br><a href="http://api.user.com/schools/grades/classes/boys">http://api.user.com/schools/grades/classes/boys</a> - 学校中所有的男生</p>
<p><a href="http://api.college.com/students/3248234/courses">http://api.college.com/students/3248234/courses</a> - 检索id为3248234的学生学习的所有课程的清单。 </p>
<h3 id="应该使用连字符”-“来提高URL的可读性，而不是使用下划线”-”"><a href="#应该使用连字符”-“来提高URL的可读性，而不是使用下划线”-”" class="headerlink" title="应该使用连字符”-“来提高URL的可读性，而不是使用下划线”_”"></a>应该使用连字符”-“来提高URL的可读性，而不是使用下划线”_”</h3><p>为了使URL容易让人们理解，请使用连字符”-“字符来提高长路径中名称的可读性。<br>一些文本查看器为了区分强调URI，常常会在URI下加上下划线。这样下划线”_”字符可能被文本查看器中默认的下划线部分地遮蔽或完全隐藏。<br>为避免这种混淆，请使用连字符”-“而不是下划线</p>
<h3 id="URL路径中首选小写字母"><a href="#URL路径中首选小写字母" class="headerlink" title="URL路径中首选小写字母"></a>URL路径中首选小写字母</h3><p>RFC 3986将URI定义为区分大小写，但scheme 和 host components除外。</p>
<h3 id="URL路径名词均为复数"><a href="#URL路径名词均为复数" class="headerlink" title="URL路径名词均为复数"></a>URL路径名词均为复数</h3><p>为了保证url格式的一致性，建议使用复数形式。</p>
<h1 id="RESTful-API对资源的操作"><a href="#RESTful-API对资源的操作" class="headerlink" title="RESTful API对资源的操作"></a>RESTful API对资源的操作</h1><p>对于rest api资源的操作，由HTTP动词表示</p>
<h3 id="CURD操作"><a href="#CURD操作" class="headerlink" title="CURD操作"></a>CURD操作</h3><ul>
<li>GET: 获取资源</li>
<li>POST： 新建资源</li>
<li>PUT：在服务器更新资源（向客户端提供改变后的所有资源）</li>
<li>PATCH: 在服务器更新资源（向客户端提供改变的属性）</li>
<li>DELETE：删除资源</li>
</ul>
<p><code>PATCH</code>一般不用，用<code>PUT</code></p>
<h3 id="资源过滤"><a href="#资源过滤" class="headerlink" title="资源过滤"></a>资源过滤</h3><p>在获取资源的时候，有可能需要获取某些“过滤”后的资源，例如指定前10行数据</p>
<p><a href="http://api.user.com/schools/grades/classes/boys?page=1&page-size=10">http://api.user.com/schools/grades/classes/boys?page=1&amp;page-size=10</a></p>
<h3 id="返回状态码推荐标准HTTP状态码"><a href="#返回状态码推荐标准HTTP状态码" class="headerlink" title="返回状态码推荐标准HTTP状态码"></a>返回状态码推荐标准HTTP状态码</h3><p>有很多服务器将返回状态码一直设为200，然后在返回body里面自定义一些状态码来表示服务器返回结果的状态码。由于rest api是直接使用的HTTP协议，所以它的状态码也要尽量使用HTTP协议的状态码。</p>
<ul>
<li>200 OK 服务器返回用户请求的数据，该操作是幂等的</li>
<li>201 CREATED 新建或者修改数据成功</li>
<li>204 NOT CONTENT 删除数据成功</li>
<li>400 BAD REQUEST 用户发出的请求有问题，该操作是幂等的</li>
<li>401 Unauthoried 表示用户没有认证，无法进行操作</li>
<li>403 Forbidden 用户访问是被禁止的</li>
<li>422 Unprocesable Entity 当创建一个对象时，发生一个验证错误</li>
<li>500 INTERNAL SERVER ERROR 服务器内部错误，用户将无法判断发出的请求是否成功</li>
<li>503 Service Unavailable 服务不可用状态，多半是因为服务器问题，例如CPU占用率大，等等</li>
</ul>
<h3 id="返回结果"><a href="#返回结果" class="headerlink" title="返回结果"></a>返回结果</h3><ul>
<li>GET &#x2F;collections  返回资源列表</li>
<li>GET &#x2F;collections&#x2F;:id 返回单独的资源</li>
<li>POST &#x2F;collections 返回新生成的资源对象</li>
<li>PUT &#x2F;collections&#x2F;:id 返回完整的资源对象</li>
<li>PATCH &#x2F;collections&#x2F;:id 返回被修改的属性</li>
<li>DELETE &#x2F;collections&#x2F;:id 返回一个空文档</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/06/28/rest-%E6%8E%A5%E5%8F%A3%E8%A7%84%E8%8C%83/" data-id="clzo46bts002bvajheko66655" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/" rel="tag">php</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blockchain/" rel="tag">Blockchain</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">Go设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web%E5%8D%8F%E8%AE%AE/" rel="tag">web协议</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%B6%E4%BB%96/" rel="tag">其他</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%97%E7%AC%A6%E9%9B%86/" rel="tag">字符集</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">正则表达式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" rel="tag">计算机基础</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Blockchain/" style="font-size: 10px;">Blockchain</a> <a href="/tags/Golang/" style="font-size: 16.67px;">Golang</a> <a href="/tags/Go%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 13.33px;">Go设计模式</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/golang/" style="font-size: 20px;">golang</a> <a href="/tags/mysql/" style="font-size: 11.67px;">mysql</a> <a href="/tags/php/" style="font-size: 18.33px;">php</a> <a href="/tags/web%E5%8D%8F%E8%AE%AE/" style="font-size: 10px;">web协议</a> <a href="/tags/%E5%85%B6%E4%BB%96/" style="font-size: 15px;">其他</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 10px;">前端</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E9%9B%86/" style="font-size: 10px;">字符集</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 10px;">正则表达式</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size: 11.67px;">计算机基础</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/12/16/singleton/">Go语言设计模式之单例模式</a>
          </li>
        
          <li>
            <a href="/2023/10/21/decorator/">Go语言设计模式之装饰模式</a>
          </li>
        
          <li>
            <a href="/2023/07/29/pattern-linked/">Go语言设计模式之责任链模式</a>
          </li>
        
          <li>
            <a href="/2022/10/16/http2/">http2.0 一篇就够了</a>
          </li>
        
          <li>
            <a href="/2022/03/19/js-learning-1/">JS的那些坑（一）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 菜刚<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>